<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <title><%= producthome.title %> — Paintello Home</title>

  <!-- Tailwind Play CDN (fast prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small custom palette to match Zara Home-like soft beige */
    :root{
      --accent: #c9b59a; /* soft beige */
      --muted: #6b6b6b;
    }
    /* Prevent layout shift from Three.js canvas while loading */
    .model-canvas { width:100%; height:100%; display:block; }
  </style>

  <!-- Three.js & STLLoader & OrbitControls (pin to specific versions used previously) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>

  <!-- Crypto lib (if used elsewhere) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" defer></script>

  <!-- Meta Pixel Code (dynamic matching preserved) -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  var pixelConfig = {};
  <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
  <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
  <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
  <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
  <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>

  fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
  fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=<%= process.env.FB_PIXEL_ID %>&ev=PageView&noscript=1"/>
  </noscript>
  <% } %>

  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>

  <!-- Google Tag Manager (kept) -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K8PWQM45');</script>

  <!-- Open Graph / structured data (kept) -->
  <meta property="og:type" content="product" />
  <meta property="og:title" content="<%= producthome.title %>" />
  <meta property="og:description" content="<%= producthome.description %>" />
  <meta property="og:image" content="<%= producthome.image[0] || producthome.image %>" />
  <meta property="og:url" content="https://<%= req.get('host') + req.originalUrl %>" />
  <meta property="product:price:amount" content="<%= producthome.price %>" />
  <meta property="product:price:currency" content="DZD" />

</head>
<body class="bg-white text-gray-800 antialiased leading-relaxed">

  <!-- Header (improved spacing) -->
  <header class="border-b border-gray-100 bg-white sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 lg:px-8"> <!-- Increased max-width and padding -->
      <div class="flex items-center justify-between h-20">
        <a href="/" class="flex items-center gap-4"> <!-- Increased gap -->
          <img src="/img/logo.png" alt="Paintello" class="h-14 w-auto" /> <!-- Slightly larger logo -->
          <span class="hidden md:inline-block text-base font-medium text-gray-700">Paintello Home</span> <!-- Larger text -->
        </a>

        <nav class="flex items-center gap-6"> <!-- Increased gap -->
          <a href="/shop" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Shop</a>
          <a href="/track-login" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Track</a>
          <a href="/user/signin" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Sign in</a>
          <a href="/shop" class="relative inline-flex items-center px-4 py-2 rounded-full bg-gray-50 hover:bg-gray-100 transition-colors"> <!-- Increased padding -->
            <i class="fas fa-shopping-cart"></i>
            <% if (session.cart && session.cart.totalQty > 0) { %>
              <span class="ml-2 text-xs font-semibold text-gray-700">(<%= session.cart.totalQty %>)</span>
            <% } %>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-6 lg:px-8 py-10"> <!-- Increased max-width -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10"> <!-- Increased gap -->

      <!-- LEFT: Images column (col-span 7) -->
      <section class="lg:col-span-7 space-y-6">

        <!-- Primary image + thumbnails - IMPROVED LAYOUT -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div class="flex flex-col lg:flex-row gap-6 p-6"> <!-- Changed to flex layout -->
            
            <!-- Thumbnails column (left) -->
            <div class="lg:w-24 flex lg:flex-col gap-3 order-2 lg:order-1 overflow-x-auto lg:overflow-visible"> <!-- Made thumbnails vertical on desktop -->
              <% producthome.image.forEach((img, idx) => { %>
                <button type="button" class="thumbnail shrink-0 rounded-lg border-2 border-transparent hover:border-[color:var(--accent)] p-1 bg-white transition-all" data-src="<%= img %>">
                  <img src="<%= img %>" alt="thumb <%= idx %>" class="w-20 h-20 lg:w-full lg:h-20 object-cover rounded-md" />
                </button>
              <% }) %>
            </div>

            <!-- Main image (right) -->
            <div class="flex-1 order-1 lg:order-2">
              <div class="flex items-center justify-center bg-gray-50 rounded-xl overflow-hidden">
                <img id="mainImage" src="<%= producthome.image[0] %>" alt="<%= producthome.title %>" class="w-full h-[500px] object-cover cursor-zoom-in" />
              </div>
            </div>

          </div>
        </div>

        <!-- Product gallery -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <% producthome.image.slice(0,4).forEach((img, idx) => { %>
            <div class="rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer">
              <img src="<%= img %>" class="w-full h-32 md:h-40 object-cover hover:scale-105 transition-transform duration-300" />
            </div>
          <% }) %>
        </div>
      </section>

      <!-- RIGHT: Product info and actions (col-span 5) -->
      <aside class="lg:col-span-5">
        <div class="bg-white rounded-2xl shadow-sm p-6 sticky top-24">
          <div class="mb-4">
            <h1 class="text-2xl font-semibold text-gray-900"><%= producthome.title %></h1>
            <p class="mt-2 text-sm text-gray-600"><%= producthome.subtitle || '' %></p>
          </div>

          <div class="flex items-end gap-3 mt-4">
            <% if (producthome.oldPrice && producthome.oldPrice > producthome.price) { %>
              <div class="text-sm text-gray-400 line-through"><%= producthome.oldPrice.toFixed(2) %> DA</div>
            <% } %>
            <div class="text-2xl font-bold text-[color:var(--accent)]"><%= producthome.price.toFixed(2) %> DA</div>
          </div>

          <p class="mt-4 text-sm text-gray-600">Free shipping over 5000 DA. Available in all wilayas.</p>

          <!-- Add to cart form -->
          <form id="addToCartForm" action="/add-to-cart-producthome/<%= producthome._id %>" method="GET" class="mt-6">
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-700 font-medium">Quantity</label>
              <div class="flex items-center border rounded-full overflow-hidden w-36">
                <button type="button" id="qtyMinus" class="px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">-</button>
                <input id="qtyInput" name="qty" value="1" class="w-12 text-center py-2 outline-none bg-transparent" />
                <button type="button" id="qtyPlus" class="px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">+</button>
              </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
              <button id="addToCartBtn" type="submit" class="w-full py-3 rounded-full text-white font-semibold hover:opacity-90 transition-opacity" style="background:var(--accent);">Add to cart</button>
              <a href="/checkout" id="buyNowBtn" class="w-full inline-flex items-center justify-center py-3 rounded-full border border-gray-200 hover:border-gray-300 transition-colors">Buy it now</a>
            </div>
          </form>

          <!-- Tabs: Description, Info, and 3D Viewer -->
          <div class="mt-8">
            <div class="flex gap-6 border-b border-gray-100">
              <button data-tab="desc" class="tab-btn text-sm py-4 px-1 font-medium text-gray-800 border-b-2 border-transparent hover:text-gray-900 active">Description</button>
              <button data-tab="info" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600 hover:text-gray-900">Information</button>
              <% if (has3DModel) { %>
                <button data-tab="model3d" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600 hover:text-gray-900">3D View</button>
              <% } %>
            </div>
            
            <div class="mt-6">
              <!-- Description Tab -->
              <div id="desc" class="tab-panel text-sm text-gray-700 leading-relaxed">
                <%= producthome.description %>
              </div>

              <!-- Information Tab -->
              <div id="info" class="tab-panel hidden text-sm text-gray-700">
                <ul class="space-y-2">
                  <% for (let key in producthome.details) { %>
                    <li class="flex border-b border-gray-100 py-2">
                      <strong class="w-32 flex-shrink-0 text-gray-900"><%= key %>:</strong>
                      <span class="flex-1"><%= producthome.details[key] %></span>
                    </li>
                  <% } %>
                </ul>
              </div>

              <!-- 3D Viewer Tab - ONLY SHOWS WHEN has3DModel is true -->
              <% if (has3DModel) { %>
                <div id="model3d" class="tab-panel hidden">
                  <div class="bg-gray-50 rounded-xl p-4">
                    <div id="modelViewer" class="w-full h-96 rounded-lg overflow-hidden"></div>
                    <p class="text-xs text-gray-500 text-center mt-3">Drag to rotate • Scroll to zoom</p>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <!-- Share / Social -->
          <div class="mt-8 flex gap-3 items-center text-sm text-gray-500 pt-6 border-t border-gray-100">
            <div class="font-medium">Share:</div>
            <a class="hover:text-gray-900 transition-colors" href="#">Facebook</a>
            <a class="hover:text-gray-900 transition-colors" href="#">Pinterest</a>
            <a class="hover:text-gray-900 transition-colors" href="#">Instagram</a>
          </div>
        </div>

        <!-- SEO / JSON-LD -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": "<%= producthome.title %>",
          "image": "<%= producthome.image[0] %>",
          "description": "<%= producthome.description %>",
          "sku": "<%= producthome._id %>",
          "offers": { "@type": "Offer", "url": "https://<%= req.get('host') + req.originalUrl %>", "priceCurrency": "DZD", "price": "<%= producthome.price %>", "availability": "https://schema.org/InStock" }
        }
        </script>
      </aside>

    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-100 bg-white mt-16">
    <div class="max-w-7xl mx-auto px-6 py-8 text-sm text-gray-600">
      © <%= new Date().getFullYear() %> Paintello — All rights reserved
    </div>
  </footer>

  <!-- Utility scripts -->
  <script>
    window.addEventListener('error', function(e){
      console.error('JS Error caught:', e.message, 'at', e.filename + ':' + e.lineno);
    });
  </script>

  <!-- Improved interaction scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Improved thumbnail switching with active state
      const mainImage = document.getElementById('mainImage');
      const thumbnails = document.querySelectorAll('.thumbnail');
      
      thumbnails.forEach(btn => {
        btn.addEventListener('click', function(){
          const src = this.dataset.src;
          if(mainImage && src) {
            mainImage.src = src;
            // Update active state
            thumbnails.forEach(t => t.classList.remove('border-[color:var(--accent)]', 'border-2'));
            this.classList.add('border-[color:var(--accent)]', 'border-2');
          }
        });
      });

      // Gallery image click to set as main
      document.querySelectorAll('.grid.grid-cols-2 img').forEach(img => {
        img.addEventListener('click', function(){
          const src = this.src;
          if(mainImage && src) {
            mainImage.src = src;
            // Find and activate corresponding thumbnail
            thumbnails.forEach(thumb => {
              if(thumb.dataset.src === src) {
                thumbnails.forEach(t => t.classList.remove('border-[color:var(--accent)]', 'border-2'));
                thumb.classList.add('border-[color:var(--accent)]', 'border-2');
              }
            });
          }
        });
      });

      // Tabs - Improved with 3D model support
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          // Update button states
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('text-gray-900', 'border-b-2', 'border-[color:var(--accent)]', 'active');
            b.classList.add('text-gray-600');
          });
          
          // Hide all panels
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
          
          // Show target panel and activate button
          const target = this.dataset.tab;
          if(target) {
            document.getElementById(target).classList.remove('hidden');
            this.classList.add('text-gray-900', 'border-b-2', 'border-[color:var(--accent)]', 'active');
            this.classList.remove('text-gray-600');
            
            // If 3D tab is activated and viewer exists, trigger resize
            if(target === 'model3d' && window.viewerInitialized) {
              setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
              }, 100);
            }
          }
        });
      });

      // Quantity controls
      const qtyInput = document.getElementById('qtyInput');
      const plus = document.getElementById('qtyPlus');
      const minus = document.getElementById('qtyMinus');
      
      if(qtyInput){
        qtyInput.value = qtyInput.value || 1;
        plus?.addEventListener('click', () => { 
          qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1); 
        });
        minus?.addEventListener('click', () => { 
          qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1); 
        });
      }

      // AddToCart tracking
      const addForm = document.getElementById('addToCartForm');
      if(addForm){
        addForm.addEventListener('submit', function(e){
          try{
            if(window.fbq) {
              window.fbq('track', 'AddToCart', {
                content_name: '<%= producthome.title %>',
                content_ids: ['<%= producthome._id %>'],
                content_type: 'product',
                value: <%= producthome.price %>,
                currency: 'DZD',
                contents: [{id: '<%= producthome._id %>', quantity: parseInt(document.getElementById('qtyInput').value||1), item_price: <%= producthome.price %>}]
              }, { eventID: '<%= metaEventIdCart %>' });
            }
          }catch(err){ console.warn('fbq track AddToCart failed', err); }
        });
      }

    });
  </script>

  <!-- 3D Viewer Initialization - ONLY for products with 3D models -->
  <% if (has3DModel) { %>
  <script>
    function init3DViewer(stlFilePath, defaultColor, autoRotateEnabled){
      try{
        if(!window.THREE || !document.getElementById('modelViewer')) return;

        let container = document.getElementById('modelViewer');
        let scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf8f9fa);
        let camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);
        let renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.innerHTML = '';
        container.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambientLight);
        const dir1 = new THREE.DirectionalLight(0xffffff, 0.9); dir1.position.set(10,10,5); scene.add(dir1);
        const dir2 = new THREE.DirectionalLight(0xffffff, 0.4); dir2.position.set(-5,5,-5); scene.add(dir2);

        let controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.autoRotate = !!autoRotateEnabled; controls.autoRotateSpeed = 1.0;

        const loader = new THREE.STLLoader();
        loader.load(stlFilePath, function(geometry){
          geometry.computeBoundingBox();
          const bbox = geometry.boundingBox;
          const center = new THREE.Vector3(); bbox.getCenter(center);

          const material = new THREE.MeshPhongMaterial({ 
            color: new THREE.Color(defaultColor || '#c9b59a'), 
            shininess: 60,
            specular: 0x222222
          });
          const mesh = new THREE.Mesh(geometry, material);

          const group = new THREE.Group();
          mesh.position.set(-center.x, -center.y, -center.z);
          group.add(mesh);

          const size = new THREE.Vector3(); bbox.getSize(size); 
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = (1.8 / maxDim) || 1;
          group.scale.set(scale, scale, scale);
          scene.add(group);

          controls.target.set(0,0,0); 
          controls.update();
          
          window.viewerInitialized = true;

        }, undefined, function(err){
          console.error('STL load error', err);
          container.innerHTML = '<div class="flex items-center justify-center h-full text-sm text-gray-500">3D preview failed to load.</div>';
        });

        function handleResize(){
          if (container.parentElement && container.parentElement.classList.contains('hidden')) return;
          
          camera.aspect = container.clientWidth / container.clientHeight; 
          camera.updateProjectionMatrix(); 
          renderer.setSize(container.clientWidth, container.clientHeight);
        }

        window.addEventListener('resize', handleResize);

        (function animate(){ 
          requestAnimationFrame(animate); 
          controls.update(); 
          renderer.render(scene, camera); 
        })();

      }catch(e){ console.error('init3DViewer error', e); }
    }

    // Initialize 3D viewer when DOM is ready
    document.addEventListener('DOMContentLoaded', function(){
      <% if (has3DModel) { %>
        setTimeout(function(){
          init3DViewer(
            '<%= model3DSettings.stlFile %>', 
            '<%= model3DSettings.defaultColor %>', 
            <%= model3DSettings.autoRotate %>
          );
        }, 500);
      <% } %>
    });
  </script>
  <% } %>

  <!-- Include fontawesome for icons -->
  <script src="https://kit.fontawesome.com/a2d9b6b9f4.js" crossorigin="anonymous" defer></script>

</body>
</html>
