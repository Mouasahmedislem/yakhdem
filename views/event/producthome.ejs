<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <title><%= producthome.title %> — Paintello Home</title>

  <!-- Tailwind Play CDN (fast prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small custom palette to match Zara Home-like soft beige */
    :root{
      --accent: #c9b59a; /* soft beige */
      --muted: #6b6b6b;
    }
    
    /* Image zoom styles */
    .zoom-container {
      position: relative;
      overflow: hidden;
      cursor: zoom-in;
    }
    
    .zoom-container.zoomed {
      cursor: zoom-out;
      overflow: visible;
    }
    
    .zoom-container.zoomed img {
      transform: scale(2);
      cursor: zoom-out;
    }
    
    /* Modal styles for fullscreen view */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .image-modal.active {
      display: flex;
    }
    
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }
    
    .modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .modal-nav:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .modal-prev {
      left: 20px;
    }
    
    .modal-next {
      right: 20px;
    }
    
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
    }
  </style>

  <!-- Three.js & STLLoader & OrbitControls -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>

  <!-- Meta Pixel Code -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  var pixelConfig = {};
  <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
  <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
  <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
  <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
  <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>

  fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
  fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=<%= process.env.FB_PIXEL_ID %>&ev=PageView&noscript=1"/>
  </noscript>
  <% } %>

  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>
</head>
<body class="bg-white text-gray-800 antialiased leading-relaxed">

  <!-- Header -->
  <header class="border-b border-gray-100 bg-white sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <a href="/" class="flex items-center gap-4">
          <img src="/img/logo.png" alt="Paintello" class="h-14 w-auto" />
          <span class="hidden md:inline-block text-base font-medium text-gray-700">Paintello Home</span>
        </a>

        <nav class="flex items-center gap-6">
          <a href="/shop" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Shop</a>
          <a href="/track-login" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Track</a>
          <a href="/user/signin" class="text-sm text-gray-600 hover:text-gray-900 transition-colors">Sign in</a>
          <a href="/shop" class="relative inline-flex items-center px-4 py-2 rounded-full bg-gray-50 hover:bg-gray-100 transition-colors">
            <i class="fas fa-shopping-cart"></i>
            <% if (session.cart && session.cart.totalQty > 0) { %>
              <span class="ml-2 text-xs font-semibold text-gray-700">(<%= session.cart.totalQty %>)</span>
            <% } %>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Image Modal for Fullscreen View -->
  <div id="imageModal" class="image-modal">
    <button class="modal-close" onclick="closeModal()">×</button>
    <button class="modal-nav modal-prev" onclick="navigateModal(-1)">‹</button>
    <button class="modal-nav modal-next" onclick="navigateModal(1)">›</button>
    <div class="modal-content">
      <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain" />
    </div>
  </div>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-6 lg:px-8 py-10">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

      <!-- LEFT: Images column -->
      <section class="lg:col-span-7 space-y-6">

        <!-- Primary image + thumbnails -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div class="flex flex-col lg:flex-row gap-6 p-6">
            
            <!-- Thumbnails column -->
            <div class="lg:w-24 flex lg:flex-col gap-3 order-2 lg:order-1 overflow-x-auto lg:overflow-visible">
              <% producthome.image.forEach((img, idx) => { %>
                <button type="button" class="thumbnail shrink-0 rounded-lg border-2 border-transparent hover:border-[color:var(--accent)] p-1 bg-white transition-all" data-src="<%= img %>" data-index="<%= idx %>">
                  <img src="<%= img %>" alt="thumb <%= idx %>" class="w-20 h-20 lg:w-full lg:h-20 object-cover rounded-md" />
                </button>
              <% }) %>
            </div>

            <!-- Main image -->
            <div class="flex-1 order-1 lg:order-2">
              <div class="zoom-container bg-gray-50 rounded-xl overflow-hidden" id="zoomContainer">
                <img id="mainImage" src="<%= producthome.image[0] %>" alt="<%= producthome.title %>" 
                     class="w-full h-[500px] object-cover cursor-zoom-in transition-transform duration-300" 
                     onclick="openModal(0)" />
              </div>
              
              <!-- Image navigation arrows for mobile -->
              <div class="flex justify-between mt-4 lg:hidden">
                <button onclick="navigateImage(-1)" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Previous</button>
                <button onclick="navigateImage(1)" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Next</button>
              </div>
            </div>

          </div>
        </div>

        <!-- Product gallery -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <% producthome.image.slice(0,4).forEach((img, idx) => { %>
            <div class="rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="openModal(<%= idx %>)">
              <img src="<%= img %>" data-index="<%= idx %>" class="w-full h-32 md:h-40 object-cover hover:scale-105 transition-transform duration-300" />
            </div>
          <% }) %>
        </div>
      </section>

      <!-- RIGHT: Product info and actions -->
      <aside class="lg:col-span-5">
        <div class="bg-white rounded-2xl shadow-sm p-6 sticky top-24">
          <!-- Product info remains the same as before -->
          <div class="mb-4">
            <h1 class="text-2xl font-semibold text-gray-900"><%= producthome.title %></h1>
            <p class="mt-2 text-sm text-gray-600"><%= producthome.subtitle || '' %></p>
          </div>

          <div class="flex items-end gap-3 mt-4">
            <% if (producthome.oldPrice && producthome.oldPrice > producthome.price) { %>
              <div class="text-sm text-gray-400 line-through"><%= producthome.oldPrice.toFixed(2) %> DA</div>
            <% } %>
            <div class="text-2xl font-bold text-[color:var(--accent)]"><%= producthome.price.toFixed(2) %> DA</div>
          </div>

          <p class="mt-4 text-sm text-gray-600">Free shipping over 5000 DA. Available in all wilayas.</p>

          <!-- Add to cart form -->
          <form id="addToCartForm" action="/add-to-cart-producthome/<%= producthome._id %>" method="GET" class="mt-6">
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-700 font-medium">Quantity</label>
              <div class="flex items-center border rounded-full overflow-hidden w-36">
                <button type="button" id="qtyMinus" class="px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">-</button>
                <input id="qtyInput" name="qty" value="1" class="w-12 text-center py-2 outline-none bg-transparent" />
                <button type="button" id="qtyPlus" class="px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">+</button>
              </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
              <button id="addToCartBtn" type="submit" class="w-full py-3 rounded-full text-white font-semibold hover:opacity-90 transition-opacity" style="background:var(--accent);">Add to cart</button>
              <a href="/checkout" id="buyNowBtn" class="w-full inline-flex items-center justify-center py-3 rounded-full border border-gray-200 hover:border-gray-300 transition-colors">Buy it now</a>
            </div>
          </form>

          <!-- Tabs: Description, Info, and 3D Viewer -->
          <div class="mt-8">
            <div class="flex gap-6 border-b border-gray-100">
              <button data-tab="desc" class="tab-btn text-sm py-4 px-1 font-medium text-gray-800 border-b-2 border-transparent hover:text-gray-900 active">Description</button>
              <button data-tab="info" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600 hover:text-gray-900">Information</button>
              <% if (has3DModel) { %>
                <button data-tab="model3d" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600 hover:text-gray-900">3D View</button>
              <% } %>
            </div>
            
            <div class="mt-6">
              <!-- Description Tab -->
              <div id="desc" class="tab-panel text-sm text-gray-700 leading-relaxed">
                <%= producthome.description %>
              </div>

              <!-- Information Tab -->
              <div id="info" class="tab-panel hidden text-sm text-gray-700">
                <ul class="space-y-2">
                  <% for (let key in producthome.details) { %>
                    <li class="flex border-b border-gray-100 py-2">
                      <strong class="w-32 flex-shrink-0 text-gray-900"><%= key %>:</strong>
                      <span class="flex-1"><%= producthome.details[key] %></span>
                    </li>
                  <% } %>
                </ul>
              </div>

              <!-- 3D Viewer Tab -->
              <% if (has3DModel) { %>
                <div id="model3d" class="tab-panel hidden">
                  <div class="bg-gray-50 rounded-xl p-4">
                    <div id="modelViewer" class="w-full h-96 rounded-lg overflow-hidden"></div>
                    <p class="text-xs text-gray-500 text-center mt-3">Drag to rotate • Scroll to zoom</p>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <!-- Share / Social -->
          <div class="mt-8 flex gap-3 items-center text-sm text-gray-500 pt-6 border-t border-gray-100">
            <div class="font-medium">Share:</div>
            <a class="hover:text-gray-900 transition-colors" href="#">Facebook</a>
            <a class="hover:text-gray-900 transition-colors" href="#">Pinterest</a>
            <a class="hover:text-gray-900 transition-colors" href="#">Instagram</a>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-100 bg-white mt-16">
    <div class="max-w-7xl mx-auto px-6 py-8 text-sm text-gray-600">
      © <%= new Date().getFullYear() %> Paintello — All rights reserved
    </div>
  </footer>

  <!-- Image Zoom and Modal Script -->
  <script>
    // Global variables for image management
    let currentImageIndex = 0;
    const productImages = <%= JSON.stringify(producthome.image) %>;
    const totalImages = productImages.length;

    // Zoom functionality
    function setupZoom() {
      const zoomContainer = document.getElementById('zoomContainer');
      const mainImage = document.getElementById('mainImage');
      
      if (!zoomContainer || !mainImage) return;

      let isZoomed = false;

      // Click to toggle zoom
      mainImage.addEventListener('click', function(e) {
        if (!isZoomed) {
          // Open modal instead of zooming
          openModal(currentImageIndex);
        }
      });

      // Mouse move for zoom effect (optional)
      zoomContainer.addEventListener('mousemove', function(e) {
        if (isZoomed) {
          const rect = this.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width) * 100;
          const y = ((e.clientY - rect.top) / rect.height) * 100;
          mainImage.style.transformOrigin = `${x}% ${y}%`;
        }
      });

      // Double click for zoom (alternative)
      mainImage.addEventListener('dblclick', function() {
        isZoomed = !isZoomed;
        zoomContainer.classList.toggle('zoomed', isZoomed);
        mainImage.style.cursor = isZoomed ? 'zoom-out' : 'zoom-in';
      });
    }

    // Modal functionality
    function openModal(index) {
      currentImageIndex = parseInt(index);
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      if (modal && modalImage && productImages[currentImageIndex]) {
        modalImage.src = productImages[currentImageIndex];
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        updateActiveThumbnail();
      }
    }

    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('active');
      document.body.style.overflow = ''; // Re-enable scrolling
    }

    function navigateModal(direction) {
      let newIndex = currentImageIndex + direction;
      if (newIndex < 0) newIndex = totalImages - 1;
      if (newIndex >= totalImages) newIndex = 0;
      openModal(newIndex);
    }

    function navigateImage(direction) {
      let newIndex = currentImageIndex + direction;
      if (newIndex < 0) newIndex = totalImages - 1;
      if (newIndex >= totalImages) newIndex = 0;
      
      changeMainImage(newIndex);
    }

    function changeMainImage(index) {
      currentImageIndex = parseInt(index);
      const mainImage = document.getElementById('mainImage');
      
      if (mainImage && productImages[currentImageIndex]) {
        mainImage.src = productImages[currentImageIndex];
        updateActiveThumbnail();
      }
    }

    function updateActiveThumbnail() {
      // Remove active class from all thumbnails
      document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('border-[color:var(--accent)]', 'border-2');
      });
      
      // Add active class to current thumbnail
      const currentThumb = document.querySelector(`.thumbnail[data-index="${currentImageIndex}"]`);
      if (currentThumb) {
        currentThumb.classList.add('border-[color:var(--accent)]', 'border-2');
      }
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Close modal when clicking on backdrop
    document.getElementById('imageModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>

  <!-- Existing Interaction Scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Initialize zoom
      setupZoom();

      // Thumbnail click functionality
      const thumbnails = document.querySelectorAll('.thumbnail');
      thumbnails.forEach(btn => {
        btn.addEventListener('click', function(){
          const index = this.dataset.index;
          changeMainImage(index);
        });
      });

      // Gallery image click
      document.querySelectorAll('.grid.grid-cols-2 img').forEach(img => {
        img.addEventListener('click', function(){
          const index = this.dataset.index;
          changeMainImage(index);
        });
      });

      // Tabs functionality
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('text-gray-900', 'border-b-2', 'border-[color:var(--accent)]', 'active');
            b.classList.add('text-gray-600');
          });
          
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
          
          const target = this.dataset.tab;
          if(target) {
            document.getElementById(target).classList.remove('hidden');
            this.classList.add('text-gray-900', 'border-b-2', 'border-[color:var(--accent)]', 'active');
            this.classList.remove('text-gray-600');
            
            if(target === 'model3d' && window.viewerInitialized) {
              setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
              }, 100);
            }
          }
        });
      });

      // Quantity controls
      const qtyInput = document.getElementById('qtyInput');
      const plus = document.getElementById('qtyPlus');
      const minus = document.getElementById('qtyMinus');
      
      if(qtyInput){
        qtyInput.value = qtyInput.value || 1;
        plus?.addEventListener('click', () => { 
          qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1); 
        });
        minus?.addEventListener('click', () => { 
          qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1); 
        });
      }

      // AddToCart tracking
      const addForm = document.getElementById('addToCartForm');
      if(addForm){
        addForm.addEventListener('submit', function(e){
          try{
            if(window.fbq) {
              window.fbq('track', 'AddToCart', {
                content_name: '<%= producthome.title %>',
                content_ids: ['<%= producthome._id %>'],
                content_type: 'product',
                value: <%= producthome.price %>,
                currency: 'DZD',
                contents: [{id: '<%= producthome._id %>', quantity: parseInt(document.getElementById('qtyInput').value||1), item_price: <%= producthome.price %>}]
              }, { eventID: '<%= metaEventIdCart %>' });
            }
          }catch(err){ console.warn('fbq track AddToCart failed', err); }
        });
      }
    });
  </script>

  <!-- 3D Viewer Script (same as before) -->
  <% if (has3DModel) { %>
  <script>
    function init3DViewer(stlFilePath, defaultColor, autoRotateEnabled){
      // ... (same 3D viewer code as before)
    }

    document.addEventListener('DOMContentLoaded', function(){
      <% if (has3DModel) { %>
        setTimeout(function(){
          init3DViewer(
            '<%= model3DSettings.stlFile %>', 
            '<%= model3DSettings.defaultColor %>', 
            <%= model3DSettings.autoRotate %>
          );
        }, 500);
      <% } %>
    });
  </script>
  <% } %>

  <!-- Include fontawesome -->
  <script src="https://kit.fontawesome.com/a2d9b6b9f4.js" crossorigin="anonymous"></script>
</body>
</html>
