<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <title><%= producthome && producthome.title ? producthome.title : 'Product' %> — Paintello Home</title>

  <!-- Tailwind (CDN for prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --accent: #f4791f; /* Paintello orange as requested */
      --muted: #6b6b6b;
    }
    /* Avoid layout shift for 3D viewer canvas */
    .model-viewer-container { min-height: 380px; }
    /* Lightbox full-screen styles */
    .lightbox-backdrop { background: rgba(0,0,0,0.9); }
    /* Smooth scroll for horizontal carousel */
    .snap-x { scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
    .snap-child { scroll-snap-align: start; }
  </style>

  <!-- THREE.js assets (deferred) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>

  <!-- Crypto lib if required by other logic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" defer></script>

  <!-- Meta Pixel (defensive) -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
  (function(f,b,e,v,n,t,s){
    if(f.fbq) return;
    n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
    t=b.createElement(e); t.async=!0; t.src=v; s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s);
  })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

  try {
    var pixelConfig = {};
    <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
    <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
    <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
    <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
    <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>
    if (typeof fbq !== 'undefined') {
      fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
      fbq('track', 'PageView');
    }
  } catch (e) { console.warn('fbq init error', e); }
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=<%= process.env.FB_PIXEL_ID %>&ev=PageView&noscript=1"/>
  </noscript>
  <% } %>

  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>

  <!-- GTM kept -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K8PWQM45');</script>

  <!-- Open Graph -->
  <meta property="og:type" content="product" />
  <meta property="og:title" content="<%= producthome && producthome.title ? producthome.title : '' %>" />
  <meta property="og:description" content="<%= producthome && producthome.description ? producthome.description : '' %>" />
  <meta property="og:image" content="<%= (producthome && producthome.image && producthome.image[0]) ? producthome.image[0] : (producthome && producthome.image ? producthome.image : '/img/placeholder.png') %>" />
  <meta property="og:url" content="https://<%= req.get('host') + req.originalUrl %>" />
  <meta property="product:price:amount" content="<%= producthome && producthome.price ? producthome.price : '' %>" />
  <meta property="product:price:currency" content="DZD" />
</head>

<body class="bg-white text-gray-800 antialiased">

  <!-- Banner (kept, modernized) -->
  <section class="relative bg-cover bg-center" style="background-image: url('https://live.staticflickr.com/65535/54530748939_dda2a74c86.jpg');">
    <div class="bg-gradient-to-b from-white/70 to-white/40">
      <div class="max-w-7xl mx-auto px-6 py-20 text-center">
        <h1 class="text-3xl md:text-4xl font-semibold text-gray-900 mb-4">Transform Your Home with Color & Comfort</h1>
        <p class="text-gray-700 mb-6">Hand-picked décor & premium home fragrance — crafted for your space.</p>
        <div class="flex items-center justify-center gap-4">
          <a href="/" class="inline-flex items-center gap-3 bg-white border border-gray-200 rounded-lg py-3 px-4 hover:shadow-sm">
            <img src="/favicon/android-chrome-192x192.png" alt="Paintello" class="h-10 w-10"/>
            <span class="text-sm font-medium text-gray-800">Home</span>
          </a>
          <a href="/paintello" class="inline-flex items-center gap-3 bg-white border border-gray-200 rounded-lg py-3 px-4 hover:shadow-sm">
            <img src="/img/logo.png" alt="Paintello" class="h-10 w-auto"/>
            <span class="text-sm font-medium text-gray-800">Paintello</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-6 lg:px-8 py-10">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

      <!-- Left: Images + gallery -->
      <section class="lg:col-span-7 space-y-6">

        <!-- Image + thumbnails layout -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden p-4">
          <div class="flex flex-col lg:flex-row gap-6">
            <!-- Thumbnails column -->
            <div class="lg:w-24 flex lg:flex-col gap-3 order-2 lg:order-1 overflow-auto">
              <% if (producthome && Array.isArray(producthome.image)) { %>
                <% producthome.image.forEach(function(img, idx) { %>
                  <button type="button" class="thumbnail shrink-0 rounded-lg border-2 border-transparent hover:border-[color:var(--accent)] p-1 bg-white transition-all" data-src="<%= img %>" aria-label="Thumbnail <%= idx+1 %>">
                    <img src="<%= img %>" alt="thumb <%= idx+1 %>" class="w-20 h-20 lg:w-full lg:h-20 object-cover rounded-md" />
                  </button>
                <% }); %>
              <% } else { %>
                <div class="text-sm text-gray-500">No images</div>
              <% } %>
            </div>

            <!-- Main image -->
            <div class="flex-1 order-1 lg:order-2">
              <div class="flex items-center justify-center bg-gray-50 rounded-xl overflow-hidden">
                <img id="mainImage" src="<%= (producthome && producthome.image && producthome.image[0]) ? producthome.image[0] : '/img/placeholder.png' %>" alt="<%= producthome && producthome.title ? producthome.title : '' %>" class="w-full h-[520px] object-cover cursor-zoom-in" />
              </div>
              <div class="mt-3 text-center">
                <button id="openLightboxBtn" class="text-sm text-[color:var(--accent)] font-medium hover:underline">View full image</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Gallery small grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <% if (producthome && Array.isArray(producthome.image)) { %>
            <% producthome.image.slice(0,4).forEach(function(img, idx){ %>
              <div class="rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                <img src="<%= img %>" class="w-full h-32 md:h-40 object-cover hover:scale-105 transition-transform duration-300" alt="gallery <%= idx+1 %>"/>
              </div>
            <% }); %>
          <% } %>
        </div>
      </section>

      <!-- Right: Product info -->
      <aside class="lg:col-span-5">
        <div class="bg-white rounded-2xl shadow-sm p-6 sticky top-24">
          <div class="mb-4">
            <h1 class="text-2xl font-semibold text-gray-900"><%= producthome && producthome.title ? producthome.title : '' %></h1>
            <p class="mt-2 text-sm text-gray-600"><%= producthome && producthome.subtitle ? producthome.subtitle : '' %></p>
          </div>

          <div class="flex items-end gap-3 mt-4">
            <% if (producthome && producthome.oldPrice && producthome.oldPrice > producthome.price) { %>
              <div class="text-sm text-gray-400 line-through"><%= Number(producthome.oldPrice).toFixed(2) %> DA</div>
            <% } %>
            <div class="text-2xl font-bold" style="color:var(--accent)"><%= producthome && typeof producthome.price !== 'undefined' ? Number(producthome.price).toFixed(2) : '' %> DA</div>
          </div>

          <p class="mt-4 text-sm text-gray-600">Free shipping over 5000 DA. Available in all wilayas.</p>

          <!-- Add to cart form -->
          <form id="addToCartForm" action="/add-to-cart-producthome/<%= producthome && producthome._id ? producthome._id : '' %>" method="GET" class="mt-6">
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-700 font-medium">Quantity</label>
              <div class="flex items-center border rounded-full overflow-hidden w-36">
                <button type="button" id="qtyMinus" class="px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">-</button>
                <input id="qtyInput" name="qty" value="1" class="w-12 text-center py-2 outline-none bg-transparent" />
                <button type="button" id="qtyPlus" class="px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors">+</button>
              </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
              <button id="addToCartBtn" type="submit" class="w-full py-3 rounded-full text-white font-semibold" style="background:var(--accent);">Add to cart</button>
              <a href="/checkout" id="buyNowBtn" class="w-full inline-flex items-center justify-center py-3 rounded-full border border-gray-200 hover:border-gray-300 transition-colors">Buy it now</a>
            </div>
          </form>

          <!-- Tabs -->
          <div class="mt-8">
            <div class="flex gap-6 border-b border-gray-100">
              <button data-tab="desc" class="tab-btn text-sm py-4 px-1 font-medium text-gray-800 border-b-2 border-transparent active">Description</button>
              <button data-tab="info" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600">Information</button>
              <% if (has3DModel) { %>
                <button data-tab="model3d" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600">3D View</button>
              <% } %>
              <% if (producthome && producthome.videoId) { %>
                <button data-tab="video" class="tab-btn text-sm py-4 px-1 font-medium text-gray-600">Video</button>
              <% } %>
            </div>

            <div class="mt-6">
              <div id="desc" class="tab-panel text-sm text-gray-700 leading-relaxed"><%= producthome && producthome.description ? producthome.description : '' %></div>

              <div id="info" class="tab-panel hidden text-sm text-gray-700">
                <ul class="space-y-2">
                  <% if (producthome && producthome.details) { for (let key in producthome.details) { %>
                    <li class="flex border-b border-gray-100 py-2">
                      <strong class="w-32 text-gray-900"><%= key %>:</strong>
                      <span class="flex-1"><%= producthome.details[key] %></span>
                    </li>
                  <% } } %>
                </ul>
              </div>

              <% if (has3DModel) { %>
                <div id="model3d" class="tab-panel hidden">
                  <div class="bg-gray-50 rounded-xl p-4">
                    <div id="modelViewer" class="model-viewer-container w-full h-96 rounded-lg overflow-hidden"></div>
                    <p class="text-xs text-gray-500 text-center mt-3">Drag to rotate • Scroll to zoom</p>
                  </div>
                </div>
              <% } %>

              <% if (producthome && producthome.videoId) { %>
                <div id="video" class="tab-panel hidden">
                  <div class="bg-white rounded-lg p-2 shadow-sm">
                    <div class="aspect-w-16 aspect-h-9">
                      <iframe src="https://www.youtube.com/embed/<%= producthome.videoId %>?rel=0&playsinline=1" class="w-full h-64" frameborder="0" allow="accelerometer; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                  </div>
                </div>
              <% } %>

            </div>
          </div>

          <!-- Share -->
          <div class="mt-8 flex gap-3 items-center text-sm text-gray-500 pt-6 border-t border-gray-100">
            <div class="font-medium">Share:</div>
            <a class="hover:text-gray-900" href="#">Facebook</a>
            <a class="hover:text-gray-900" href="#">Pinterest</a>
            <a class="hover:text-gray-900" href="#">Instagram</a>
          </div>
        </div>

        <!-- JSON-LD -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": "<%= producthome && producthome.title ? producthome.title : '' %>",
          "image": "<%= (producthome && producthome.image && producthome.image[0]) ? producthome.image[0] : '' %>",
          "description": "<%= producthome && producthome.description ? producthome.description : '' %>",
          "sku": "<%= producthome && producthome._id ? producthome._id : '' %>",
          "offers": { "@type": "Offer", "url": "https://<%= req.get('host') + req.originalUrl %>", "priceCurrency": "DZD", "price": "<%= producthome && producthome.price ? producthome.price : '' %>", "availability": "https://schema.org/InStock" }
        }
        </script>
      </aside>
    </div>

   <!-- Suggested products (horizontal scroll carousel) -->
<section class="mt-12">
  <h2 class="text-xl font-semibold mb-4">You may also like</h2>
  <div class="relative">
    <!-- Arrows -->
    <button id="prevRelated" class="absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-white rounded-full shadow p-2 hidden md:block" aria-label="Previous">
      <svg class="h-5 w-5 text-gray-700" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M12.707 14.707a1 1 0 01-1.414 0L6.586 10l4.707-4.707a1 1 0 011.414 1.414L9.414 10l3.293 3.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
      </svg>
    </button>
    <button id="nextRelated" class="absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-white rounded-full shadow p-2 hidden md:block" aria-label="Next">
      <svg class="h-5 w-5 text-gray-700" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M7.293 5.293a1 1 0 011.414 0L13.414 10l-4.707 4.707a1 1 0 01-1.414-1.414L10.586 10 7.293 6.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
      </svg>
    </button>

    <!-- Scroll container -->
    <div id="relatedScroll" class="flex gap-4 overflow-x-auto snap-x py-2 px-2">
      <!-- Render paintello products as related products -->
      <% if (typeof paintellos !== 'undefined' && Array.isArray(paintellos) && paintellos.length > 0) { %>
        <% 
          // Filter out current product if it exists in paintellos
          const relatedProducts = paintellos.filter(p => {
            return !(producthome && producthome._id && p._id && producthome._id.toString() === p._id.toString());
          }).slice(0, 8); // Limit to 8 products
        %>
        
        <% if (relatedProducts.length > 0) { %>
          <% relatedProducts.forEach(function(p) { %>
            <div class="snap-child flex-none w-56 bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow duration-300">
              <a href="<%= p.href || '/paintello/product/' + p._id %>" class="block group">
                <div class="relative overflow-hidden">
                  <img src="<%= (p.image && p.image[0]) ? p.image[0] : '/img/placeholder.png' %>" 
                       alt="<%= p.title %>" 
                       class="w-full h-36 object-cover group-hover:scale-105 transition-transform duration-300" />
                  <% if (p.disponible && p.disponible.includes('Sale')) { %>
                    <span class="absolute top-2 left-2 bg-red-500 text-white text-xs px-2 py-1 rounded">Sale</span>
                  <% } %>
                </div>
                <div class="p-3">
                  <div class="text-sm font-medium text-gray-900 truncate"><%= p.title %></div>
                  <div class="flex items-center gap-2 mt-1">
                    <div class="text-sm font-semibold text-[color:var(--accent)]">
                      <%= p.price ? Number(p.price).toFixed(2) : '0.00' %> DA
                    </div>
                    <% if (p.oldPrice && p.oldPrice > p.price) { %>
                      <div class="text-xs text-gray-500 line-through">
                        <%= Number(p.oldPrice).toFixed(2) %> DA
                      </div>
                    <% } %>
                  </div>
                  <% if (p.disponible && !p.disponible.includes('Sale')) { %>
                    <span class="inline-block mt-1 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                      <%= p.disponible %>
                    </span>
                  <% } %>
                </div>
              </a>
            </div>
          <% }); %>
        <% } else { %>
          <!-- Fallback if no related products found -->
          <div class="w-full text-center py-8 text-gray-500">
            Check out our other products
          </div>
        <% } %>
      <% } else { %>
        <!-- Placeholders when no paintello data available -->
        <% for (let i=0; i<6; i++){ %>
          <div class="snap-child flex-none w-56 bg-white rounded-xl shadow-sm overflow-hidden">
            <a href="#" class="block">
              <img src="/img/placeholder.png" alt="placeholder" class="w-full h-36 object-cover" />
              <div class="p-3">
                <div class="text-sm font-medium text-gray-900 truncate">Featured Product <%= i+1 %></div>
                <div class="text-sm text-[color:var(--accent)] mt-1">199.99 DA</div>
              </div>
            </a>
          </div>
        <% } %>
      <% } %>
    </div>
  </div>
</section>

  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-100 bg-white mt-16">
    <div class="max-w-7xl mx-auto px-6 py-8 text-sm text-gray-600">© <%= new Date().getFullYear() %> Paintello — All rights reserved</div>
  </footer>

  <!-- Global error handlers (helpful for Clarity) -->
  <script>
    window.addEventListener('error', function(e) {
      try { console.error('JS Error caught:', e.message, 'at', (e.filename || e.fileName) + ':' + (e.lineno || e.lineNumber), e.error); } catch (err) {}
    });
    window.addEventListener('unhandledrejection', function(e) { console.warn('Unhandled promise rejection', e.reason); });
  </script>

  <!-- Interaction scripts (lightbox, thumbnails, tabs, qty, addToCart tracking) -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){

      // ---------- Lightbox full image viewer ----------
      const lightbox = (function(){
        // create elements
        const backdrop = document.createElement('div');
        backdrop.className = 'fixed inset-0 z-50 flex items-center justify-center lightbox-backdrop hidden';
        backdrop.style.padding = '1rem';
        backdrop.innerHTML = `
          <div class="relative max-w-5xl w-full h-full flex items-center justify-center">
            <button id="lightboxClose" class="absolute top-4 right-4 text-white text-3xl leading-none z-60" aria-label="Close">×</button>
            <img id="lightboxImage" src="" alt="Full image" class="max-h-full max-w-full object-contain rounded-lg shadow-lg" />
          </div>
        `;
        document.body.appendChild(backdrop);

        const openBtn = document.getElementById('openLightboxBtn');
        const mainImage = document.getElementById('mainImage');

        function open(src) {
          const imgEl = document.getElementById('lightboxImage');
          imgEl.src = src || (mainImage ? mainImage.src : '');
          backdrop.classList.remove('hidden');
          backdrop.classList.add('flex');
          document.documentElement.style.overflow = 'hidden';
        }
        function close() {
          backdrop.classList.add('hidden');
          backdrop.classList.remove('flex');
          document.documentElement.style.overflow = '';
        }

        // events
        backdrop.addEventListener('click', function(e){
          if (e.target === backdrop) close();
        });
        backdrop.querySelector('#lightboxClose').addEventListener('click', close);

        if (openBtn) openBtn.addEventListener('click', function(){ open(); });
        if (mainImage) mainImage.addEventListener('click', function(){ open(); });

        // allow ESC to close
        document.addEventListener('keydown', function(e){ if (e.key === 'Escape') close(); });

        return { open, close };
      })();

      // ---------- Thumbnail switching ----------
      const thumbnails = document.querySelectorAll('.thumbnail');
      const mainImage = document.getElementById('mainImage');
      thumbnails.forEach(btn => {
        btn.addEventListener('click', function(){
          const src = this.dataset.src;
          if (mainImage && src) {
            mainImage.src = src;
            // set active border style
            thumbnails.forEach(t => { t.classList.remove('!border-2'); t.classList.remove('!border-[color:var(--accent)]'); });
            this.classList.add('!border-2');
            this.classList.add('!border-[color:var(--accent)]');
          }
        });
      });

      // gallery click to main
      document.querySelectorAll('.grid img').forEach(img => {
        img.addEventListener('click', function(){
          const src = this.src;
          if (mainImage && src) mainImage.src = src;
          // mark thumbnail if matches
          thumbnails.forEach(t => {
            if (t.dataset.src === src) {
              thumbnails.forEach(x=> { x.classList.remove('!border-2'); x.classList.remove('!border-[color:var(--accent)]'); });
              t.classList.add('!border-2');
              t.classList.add('!border-[color:var(--accent)]');
            }
          });
        });
      });

      // ---------- Tabs ----------
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          const target = this.dataset.tab;
          if (!target) return;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-gray-900', 'active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
          this.classList.add('text-gray-900', 'active');
          const panel = document.getElementById(target);
          if (panel) panel.classList.remove('hidden');

          // trigger a resize if model viewer becomes visible
          if (target === 'model3d') {
            setTimeout(()=> window.dispatchEvent(new Event('resize')), 120);
          }
        });
      });

      // ---------- Quantity controls ----------
      const qtyInput = document.getElementById('qtyInput');
      const plus = document.getElementById('qtyPlus');
      const minus = document.getElementById('qtyMinus');
      if (qtyInput) {
        qtyInput.value = qtyInput.value || 1;
        plus && plus.addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1));
        minus && minus.addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1));
      }

      // ---------- AddToCart tracking (safe) ----------
      const addForm = document.getElementById('addToCartForm');
      if (addForm) {
        addForm.addEventListener('submit', function(e){
          try {
            if (window.fbq) {
              window.fbq('track', 'AddToCart', {
                content_name: '<%= producthome && producthome.title ? producthome.title : '' %>',
                content_ids: ['<%= producthome && producthome._id ? producthome._id : '' %>'],
                content_type: 'product',
                value: <%= producthome && producthome.price ? producthome.price : 0 %>,
                currency: 'DZD',
                contents: [{ id: '<%= producthome && producthome._id ? producthome._id : '' %>', quantity: parseInt(document.getElementById('qtyInput').value||1), item_price: <%= producthome && producthome.price ? producthome.price : 0 %> }]
              }, { eventID: '<%= typeof metaEventIdCart !== "undefined" ? metaEventIdCart : "" %>' });
            }
          } catch (err) { console.warn('fbq track AddToCart failed', err); }
          // allow the form to proceed normally
        });
      }

      // ---------- Related products carousel controls ----------
      const relatedScroll = document.getElementById('relatedScroll');
      const prevBtn = document.getElementById('prevRelated');
      const nextBtn = document.getElementById('nextRelated');

      function scrollRelated(delta) {
        if (!relatedScroll) return;
        relatedScroll.scrollBy({ left: delta, behavior: 'smooth' });
      }
      if (prevBtn) prevBtn.addEventListener('click', () => scrollRelated(-280));
      if (nextBtn) nextBtn.addEventListener('click', () => scrollRelated(280));

      // show/hide arrows based on width
      function updateRelatedArrows() {
        if (!relatedScroll) return;
        if (relatedScroll.scrollWidth > relatedScroll.clientWidth) {
          prevBtn && prevBtn.classList.remove('hidden');
          nextBtn && nextBtn.classList.remove('hidden');
        } else {
          prevBtn && prevBtn.classList.add('hidden');
          nextBtn && nextBtn.classList.add('hidden');
        }
      }
      setTimeout(updateRelatedArrows, 300);
      window.addEventListener('resize', updateRelatedArrows);

    }); // DOMContentLoaded end
  </script>

  <!-- 3D Viewer (robust) -->
  <% if (has3DModel) { %>
  <script>
    (function(){
      function waitForThree(cb, timeoutMs) {
        const start = Date.now();
        (function check() {
          if (window.THREE && (window.THREE.STLLoader || window.STLLoader)) return cb();
          if (Date.now() - start > (timeoutMs || 8000)) { console.warn('Three.js assets not available'); return; }
          setTimeout(check, 80);
        })();
      }

      function init3DViewer(stlFilePath, defaultColor, autoRotateEnabled) {
        try {
          const container = document.getElementById('modelViewer');
          if (!container || !window.THREE) return;

          // cleanup any previous canvas
          container.innerHTML = '';
          const scene = new THREE.Scene();
          scene.background = new THREE.Color(0xf8f9fa);
          const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
          camera.position.set(0, 0, 5);

          const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
          renderer.setPixelRatio(window.devicePixelRatio || 1);
          renderer.setSize(container.clientWidth, container.clientHeight);
          container.appendChild(renderer.domElement);

          const ambient = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambient);
          const d1 = new THREE.DirectionalLight(0xffffff, 0.9); d1.position.set(10,10,5); scene.add(d1);
          const d2 = new THREE.DirectionalLight(0xffffff, 0.4); d2.position.set(-5,5,-5); scene.add(d2);

          const controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true; controls.dampingFactor = 0.05;
          controls.autoRotate = !!autoRotateEnabled; controls.autoRotateSpeed = 1.0;

          const LoaderClass = (typeof THREE.STLLoader !== 'undefined') ? THREE.STLLoader : (typeof STLLoader !== 'undefined' ? STLLoader : null);
          if (!LoaderClass) {
            container.innerHTML = '<div class="flex items-center justify-center h-full text-sm text-gray-500">3D preview not supported</div>';
            return;
          }
          const loader = new LoaderClass();

          loader.load(stlFilePath, function(geometry) {
            try {
              geometry.computeBoundingBox();
              const bbox = geometry.boundingBox;
              const center = new THREE.Vector3(); bbox.getCenter(center);

              const material = new THREE.MeshPhongMaterial({ color: new THREE.Color(defaultColor || '#c9b59a'), shininess: 60, specular: 0x222222 });
              const mesh = new THREE.Mesh(geometry, material);

              const group = new THREE.Group();
              mesh.position.set(-center.x, -center.y, -center.z);
              group.add(mesh);

              const size = new THREE.Vector3(); bbox.getSize(size);
              const maxDim = Math.max(size.x, size.y, size.z);
              const scale = (maxDim > 0 ? 1.8 / maxDim : 1);
              group.scale.set(scale, scale, scale);
              scene.add(group);

              controls.target.set(0,0,0);
              controls.update();
              window.viewerInitialized = true;
            } catch (err) {
              console.error('3D geometry error', err);
            }
          }, undefined, function(err){
            console.error('STL load error', err);
            container.innerHTML = '<div class="flex items-center justify-center h-full text-sm text-gray-500">3D preview failed to load.</div>';
          });

          function handleResize() {
            if (!container) return;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
          }
          window.addEventListener('resize', handleResize);

          (function animate(){
            try {
              requestAnimationFrame(animate);
              controls.update();
              renderer.render(scene, camera);
            } catch(e) { console.error('render loop error', e); }
          })();

        } catch(e) { console.error('init3DViewer error', e); }
      }

      document.addEventListener('DOMContentLoaded', function(){
        waitForThree(function(){ 
          try {
            init3DViewer('<%= model3DSettings && model3DSettings.stlFile ? model3DSettings.stlFile : '' %>', '<%= model3DSettings && model3DSettings.defaultColor ? model3DSettings.defaultColor : '#c9b59a' %>', <%= model3DSettings && typeof model3DSettings.autoRotate !== 'undefined' ? model3DSettings.autoRotate : false %>);
          } catch(e) { console.error('init3DViewer call failed', e); }
        }, 8000);
      });
    })();
  </script>
  <% } %>

  <!-- FontAwesome icons -->
  <script src="https://kit.fontawesome.com/a2d9b6b9f4.js" crossorigin="anonymous" defer></script>
</body>
</html>

