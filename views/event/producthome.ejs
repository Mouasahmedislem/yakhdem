<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <title><%= producthome.title %> — Paintello Home</title>

  <!-- Tailwind Play CDN (fast prototyping) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Small custom palette to match Zara Home-like soft beige */
    :root{
      --accent: #c9b59a; /* soft beige */
      --muted: #6b6b6b;
    }
    /* Prevent layout shift from Three.js canvas while loading */
    .model-canvas { width:100%; height:100%; display:block; }
  </style>

  <!-- Three.js & STLLoader & OrbitControls (pin to specific versions used previously) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" defer></script>

  <!-- Crypto lib (if used elsewhere) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" defer></script>

  <!-- Meta Pixel Code (dynamic matching preserved) -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  var pixelConfig = {};
  <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
  <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
  <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
  <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
  <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>

  fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
  fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=<%= process.env.FB_PIXEL_ID %>&ev=PageView&noscript=1"/>
  </noscript>
  <% } %>

  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>

  <!-- Google Tag Manager (kept) -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K8PWQM45');</script>

  <!-- Open Graph / structured data (kept) -->
  <meta property="og:type" content="product" />
  <meta property="og:title" content="<%= producthome.title %>" />
  <meta property="og:description" content="<%= producthome.description %>" />
  <meta property="og:image" content="<%= producthome.image[0] || producthome.image %>" />
  <meta property="og:url" content="https://<%= req.get('host') + req.originalUrl %>" />
  <meta property="product:price:amount" content="<%= producthome.price %>" />
  <meta property="product:price:currency" content="DZD" />

</head>
<body class="bg-white text-gray-800 antialiased leading-relaxed">

  <!-- Header (minimal, responsive) -->
  <header class="border-b border-gray-100 bg-white sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <a href="/" class="flex items-center gap-3">
          <img src="/img/logo.png" alt="Paintello" class="h-12 w-auto" />
          <span class="hidden md:inline-block text-sm font-medium text-gray-700">Paintello Home</span>
        </a>

        <nav class="flex items-center gap-4">
          <a href="/shop" class="text-sm text-gray-600 hover:text-gray-900">Shop</a>
          <a href="/track-login" class="text-sm text-gray-600 hover:text-gray-900">Track</a>
          <a href="/user/signin" class="text-sm text-gray-600 hover:text-gray-900">Sign in</a>
          <a href="/shop" class="relative inline-flex items-center px-3 py-2 rounded-full bg-gray-50 hover:bg-gray-100">
            <i class="fas fa-shopping-cart"></i>
            <% if (session.cart && session.cart.totalQty > 0) { %>
              <span class="ml-2 text-xs font-semibold text-gray-700">(<%= session.cart.totalQty %>)</span>
            <% } %>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-10">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

      <!-- LEFT: Images + 3D viewer column (col-span 7) -->
      <section class="lg:col-span-7 space-y-6">

        <!-- Primary image + thumbnails -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4">
            <div class="flex items-center justify-center">
              <img id="mainImage" src="<%= producthome.image[0] %>" alt="<%= producthome.title %>" class="w-full h-[420px] object-cover rounded-lg" />
            </div>
            <div class="flex flex-col gap-3">
              <div class="flex-1 flex items-center justify-center rounded-lg overflow-hidden bg-gray-50">
                <!-- 3D viewer placeholder / canvas -->
                <% if (has3DModel) { %>
                  <div id="modelViewer" class="w-full h-[420px] model-viewer-container"></div>
                <% } else { %>
                  <div class="p-6 text-center text-sm text-gray-500">No 3D preview available</div>
                <% } %>
              </div>

              <!-- thumbnails row -->
              <div class="flex gap-3 mt-3 overflow-x-auto py-2">
                <% producthome.image.forEach((img, idx) => { %>
                  <button type="button" class="thumbnail shrink-0 rounded-lg border border-gray-100 p-1 bg-white" data-src="<%= img %>">
                    <img src="<%= img %>" alt="thumb <%= idx %>" class="w-24 h-20 object-cover rounded-md" />
                  </button>
                <% }) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Product gallery (optional larger carousel) -->
        <div class="grid grid-cols-2 gap-4">
          <% producthome.image.slice(0,4).forEach(img => { %>
            <div class="rounded-lg overflow-hidden bg-white shadow-sm">
              <img src="<%= img %>" class="w-full h-40 object-cover" />
            </div>
          <% }) %>
        </div>
      </section>

      <!-- RIGHT: Product info and actions (col-span 5) -->
      <aside class="lg:col-span-5">
        <div class="bg-white rounded-2xl shadow-sm p-6 sticky top-24">
          <div class="mb-3">
            <h1 class="text-2xl font-semibold text-gray-900"><%= producthome.title %></h1>
            <p class="mt-2 text-sm text-gray-600"><%= producthome.subtitle || '' %></p>
          </div>

          <div class="flex items-end gap-3 mt-4">
            <% if (producthome.oldPrice && producthome.oldPrice > producthome.price) { %>
              <div class="text-sm text-gray-400 line-through"><%= producthome.oldPrice.toFixed(2) %> DA</div>
            <% } %>
            <div class="text-2xl font-bold text-[color:var(--accent)]"><%= producthome.price.toFixed(2) %> DA</div>
          </div>

          <p class="mt-4 text-sm text-gray-600">Free shipping over 5000 DA. Available in all wilayas.</p>

          <!-- Add to cart form (preserve existing route) -->
          <form id="addToCartForm" action="/add-to-cart-producthome/<%= producthome._id %>" method="GET" class="mt-6">
            <div class="flex items-center gap-3">
              <label class="text-sm text-gray-700">Quantity</label>
              <div class="flex items-center border rounded-full overflow-hidden w-36">
                <button type="button" id="qtyMinus" class="px-4 py-2 text-gray-700">-</button>
                <input id="qtyInput" name="qty" value="1" class="w-12 text-center py-2 outline-none" />
                <button type="button" id="qtyPlus" class="px-4 py-2 text-gray-700">+</button>
              </div>
            </div>

            <div class="mt-6 flex flex-col gap-3">
              <button id="addToCartBtn" type="submit" class="w-full py-3 rounded-full text-white font-semibold" style="background:var(--accent);">Add to cart</button>

              <a href="/checkout" id="buyNowBtn" class="w-full inline-flex items-center justify-center py-3 rounded-full border border-gray-200">Buy it now</a>
            </div>
          </form>

          <!-- Tabs: Description and Info -->
          <div class="mt-6">
            <div class="flex gap-3 border-b border-gray-100">
              <button data-tab="desc" class="tab-btn text-sm py-3 px-1 font-medium text-gray-800 border-b-2 border-transparent active">Description</button>
              <button data-tab="info" class="tab-btn text-sm py-3 px-1 font-medium text-gray-600">Information</button>
            </div>
            <div class="mt-4">
              <div id="desc" class="tab-panel text-sm text-gray-700"><%= producthome.description %></div>
              <div id="info" class="tab-panel hidden text-sm text-gray-700">
                <ul class="list-disc pl-5">
                  <% for (let key in producthome.details) { %>
                    <li><strong><%= key %>:</strong> <%= producthome.details[key] %></li>
                  <% } %>
                </ul>
              </div>
            </div>
          </div>

          <!-- Share / Social (light) -->
          <div class="mt-6 flex gap-3 items-center text-sm text-gray-500">
            <div>Share:</div>
            <a class="hover:text-gray-900" href="#">Facebook</a>
            <a class="hover:text-gray-900" href="#">Pinterest</a>
          </div>
        </div>

        <!-- SEO / JSON-LD preserved below for bots -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": "<%= producthome.title %>",
          "image": "<%= producthome.image[0] %>",
          "description": "<%= producthome.description %>",
          "sku": "<%= producthome._id %>",
          "offers": { "@type": "Offer", "url": "https://<%= req.get('host') + req.originalUrl %>", "priceCurrency": "DZD", "price": "<%= producthome.price %>", "availability": "https://schema.org/InStock" }
        }
        </script>
      </aside>

    </div>
  </main>

  <!-- Footer (simple) -->
  <footer class="border-t border-gray-100 bg-white">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm text-gray-600">
      © <%= new Date().getFullYear() %> Paintello — All rights reserved
    </div>
  </footer>

  <!-- Utility scripts -->
  <script>
    // Safety: global error logger to console (helps debug Clarity issues)
    window.addEventListener('error', function(e){
      console.error('JS Error caught:', e.message, 'at', e.filename + ':' + e.lineno);
    });
  </script>

  <!-- Small interaction scripts (defer to ensure DOM present) -->
  <script>
    // Thumbnail -> main image
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.thumbnail').forEach(btn => {
        btn.addEventListener('click', function(){
          const src = this.dataset.src;
          const main = document.getElementById('mainImage');
          if(main && src) main.src = src;
        });
      });

      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('text-gray-900','active'));
          document.querySelectorAll('.tab-panel').forEach(p=>p.classList.add('hidden'));
          const target = this.dataset.tab || this.getAttribute('data-tab');
          if(target) document.getElementById(target).classList.remove('hidden');
          this.classList.add('text-gray-900','active');
        });
      });

      // Quantity controls
      const qtyInput = document.getElementById('qtyInput');
      const plus = document.getElementById('qtyPlus');
      const minus = document.getElementById('qtyMinus');
      if(qtyInput){
        qtyInput.value = qtyInput.value || 1;
        plus?.addEventListener('click', ()=> { qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1); });
        minus?.addEventListener('click', ()=> { qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1); });
      }

      // AddToCart tracking: ensure fbq exists and form submission proceeds
      const addForm = document.getElementById('addToCartForm');
      const addBtn = document.getElementById('addToCartBtn');
      if(addForm){
        addForm.addEventListener('submit', function(e){
          // Fire fbq safely
          try{
            if(window.fbq) {
              window.fbq('track', 'AddToCart', {
                content_name: '<%= producthome.title %>',
                content_ids: ['<%= producthome._id %>'],
                content_type: 'product',
                value: <%= producthome.price %>,
                currency: 'DZD',
                contents: [{id: '<%= producthome._id %>', quantity: parseInt(document.getElementById('qtyInput').value||1), item_price: <%= producthome.price %>}]
              }, { eventID: '<%= metaEventIdCart %>' });
            }
          }catch(err){ console.warn('fbq track AddToCart failed', err); }
          // allow form to submit normally
        });
      }

      // Minimal defensive check for Buy Now
      const buyNow = document.getElementById('buyNowBtn');
      if(buyNow){ buyNow.addEventListener('click', ()=>{ /* optionally add tracking */ }); }

    });
  </script>

  <!-- 3D Viewer Initialization (deferred until Three.js loaded) -->
  <script>
    // Initialize 3D viewer only when necessary and when scripts loaded
    function init3DViewer(stlFilePath, defaultColor, autoRotateEnabled){
      try{
        // Basic safety checks
        if(!window.THREE || !document.getElementById('modelViewer')) return;

        // Copy the robust viewer logic from your previous implementation with safe guards
        let container = document.getElementById('modelViewer');
        let scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf8f9fa);
        let camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 0, 5);
        let renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.innerHTML = '';
        container.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambientLight);
        const dir1 = new THREE.DirectionalLight(0xffffff, 0.9); dir1.position.set(10,10,5); scene.add(dir1);
        const dir2 = new THREE.DirectionalLight(0xffffff, 0.4); dir2.position.set(-5,5,-5); scene.add(dir2);

        let controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.autoRotate = !!autoRotateEnabled; controls.autoRotateSpeed = 1.0;

        const loader = new THREE.STLLoader();
        loader.load(stlFilePath, function(geometry){
          geometry.computeBoundingBox();
          const bbox = geometry.boundingBox;
          const center = new THREE.Vector3(); bbox.getCenter(center);

          const material = new THREE.MeshPhongMaterial({ color: new THREE.Color(defaultColor || '#c9b59a'), shininess: 60 });
          const mesh = new THREE.Mesh(geometry, material);

          const group = new THREE.Group();
          mesh.position.set(-center.x, -center.y, -center.z);
          group.add(mesh);

          const size = new THREE.Vector3(); bbox.getSize(size); const maxDim = Math.max(size.x,size.y,size.z);
          const scale = (1.8 / maxDim) || 1;
          group.scale.set(scale, scale, scale);
          scene.add(group);

          controls.target.set(0,0,0); controls.update();
        }, undefined, function(err){
          console.error('STL load error', err);
          document.getElementById('modelViewer').innerHTML = '<div class="p-6 text-center text-sm text-gray-500">3D preview failed to load.</div>';
        });

        window.addEventListener('resize', function(){
          camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight);
        });

        (function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); })();

      }catch(e){ console.error('init3DViewer error', e); }
    }

    // Defer initialization until Three.js available
    document.addEventListener('DOMContentLoaded', function(){
      <% if (has3DModel) { %>
        // small timeout to ensure loader script executed
        setTimeout(function(){
          init3DViewer('<%= model3DSettings.stlFile %>', '<%= model3DSettings.defaultColor %>', <%= model3DSettings.autoRotate %>);
        }, 300);
      <% } %>
    });
  </script>

  <!-- Include fontawesome for icons (defer) -->
  <script src="https://kit.fontawesome.com/a2d9b6b9f4.js" crossorigin="anonymous" defer></script>

  <!-- End body -->
</body>
</html>
