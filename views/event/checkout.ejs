<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paintello — Checkout</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f8f8f8;
    }
    
    .zara-card {
      background: white;
      border-radius: 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e5e5e5;
    }
    
    .zara-btn {
      background: #000;
      color: white;
      border: 1px solid #000;
      padding: 12px 24px;
      font-size: 13px;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }
    
    .zara-btn:hover {
      background: #333;
    }
    
    .zara-btn-secondary {
      background: transparent;
      color: #000;
      border: 1px solid #000;
    }
    
    .zara-btn-secondary:hover {
      background: #000;
      color: white;
    }
    
    .input {
      @apply w-full px-4 py-3 border border-gray-300 rounded-none focus:outline-none focus:border-black text-sm;
    }
    
    .label {
      @apply text-xs font-medium text-gray-700 mb-2 uppercase tracking-wide;
    }
  </style>

  <!-- Crypto lib (used elsewhere) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" defer></script>

  <!-- Meta Pixel Code (advanced matching preserved) -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  try {
    var pixelConfig = {};
    <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
    <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
    <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
    <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
    <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>
    fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
    fbq('track', 'PageView');
  } catch (e) { console.warn('fbq init error', e); }
  </script>
  <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=<%= process.env.FB_PIXEL_ID %>&ev=PageView&noscript=1"/></noscript>
  <% } %>

  <!-- Microsoft Clarity -->
  <script>
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>

  <!-- GTM (kept) -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K8PWQM45');</script>

</head>
<body class="min-h-screen bg-white">

  <!-- Minimal Header -->
  <header class="border-b border-gray-200 bg-white">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- Logo -->
        <a href="/" class="flex items-center gap-4">
          <img src="/favicon/android-chrome-192x192.png" alt="Paintello" class="h-8 w-8">
          <img src="/img/logo.png" alt="Paintello Home" class="h-10 w-auto">
        </a>

        <!-- Navigation -->
        <nav class="hidden md:flex items-center gap-8">
          <a href="/" class="text-sm text-gray-600 hover:text-gray-900 uppercase tracking-wide">Accueil</a>
          <a href="/shop" class="text-sm text-gray-600 hover:text-gray-900 uppercase tracking-wide">Boutique</a>
          <a href="/track-login" class="text-sm text-gray-600 hover:text-gray-900 uppercase tracking-wide">Suivi</a>
        </nav>

        <!-- Icons -->
        <div class="flex items-center gap-4">
          <a href="/shop" class="relative text-gray-600 hover:text-gray-900">
            <i class="fa-solid fa-bag-shopping text-lg"></i>
            <% if (session.cart && session.cart.totalQty > 0) { %>
              <span class="absolute -top-2 -right-2 bg-black text-white text-xs px-1.5 py-0.5 rounded-full">
                <%= session.cart.totalQty %>
              </span>
            <% } %>
          </a>
          
          <a href="/user/profile" class="text-gray-600 hover:text-gray-900">
            <i class="fa-regular fa-user text-lg"></i>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="py-12">
    <div class="max-w-4xl mx-auto px-6">
      
      <!-- Page Header -->
      <div class="text-center mb-12">
        <h1 class="text-3xl font-light tracking-wide uppercase mb-4">Finaliser votre commande</h1>
        <p class="text-sm text-gray-600 max-w-2xl mx-auto leading-relaxed">
          Remplissez vos coordonnées. Les frais de livraison et le délai estimé sont calculés automatiquement.
        </p>
      </div>

      <!-- Checkout Form -->
      <div class="grid md:grid-cols-3 gap-12">
        <!-- Left Column - Form -->
        <div class="md:col-span-2">
          <div class="zara-card p-8">
            <form id="checkoutForm" action="/checkout" method="POST" class="space-y-8">
              
              <!-- Personal Information -->
              <div>
                <h3 class="text-sm font-medium uppercase tracking-wide mb-6 border-b pb-2">Informations personnelles</h3>
               <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <!-- First Name -->
  <div>
    <label class="label" for="firstName">Prénom</label>
    <input required type="text" id="firstName" name="firstName" value="<%= user && user.firstName ? user.firstName : '' %>" class="input" placeholder="Votre prénom">
  </div>

  <!-- Last Name -->
  <div>
    <label class="label" for="lastName">Nom</label>
    <input required type="text" id="lastName" name="lastName" value="<%= user && user.lastName ? user.lastName : '' %>" class="input" placeholder="Votre nom">
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <!-- Phone -->
  <div>
    <label class="label" for="numero">Téléphone</label>
    <input required type="tel" id="numero" name="numero" pattern="0[5-7][0-9]{8}" placeholder="e.g. 0551234567" value="<%= user && user.numero ? user.numero : '' %>" class="input">
    <p class="text-xs text-gray-500 mt-2">Format : 0xx xxxxxxx</p>
  </div>
</div>
              </div>

              <!-- Address -->
              <div>
                <h3 class="text-sm font-medium uppercase tracking-wide mb-6 border-b pb-2">Adresse de livraison</h3>
                
                <!-- Address -->
                <div class="mb-6">
                  <label class="label" for="address">Adresse complète</label>
                  <input required type="text" id="address" name="address" placeholder="Rue, n°, immeuble..." class="input" value="<%= typeof address !== 'undefined' ? address : '' %>">
                </div>

                <!-- Wilaya & Commune -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="label" for="city">Wilaya (province)</label>
                    <select id="city" name="city" required class="input">
                      <option value="">Sélectionnez votre wilaya</option>
                      <option value="adrar">Adrar</option>
                      <option value="chlef">Chlef</option>
                      <option value="laghouat">Laghouat</option>
                      <option value="oum el bouaghi">Oum El Bouaghi</option>
                      <option value="batna">Batna</option>
                      <option value="bejaia">Bejaia</option>
                      <option value="biskra">Biskra</option>
                      <option value="bechar">Bechar</option>
                      <option value="blida">Blida</option>
                      <option value="bouira">Bouira</option>
                      <option value="tamanrasset">Tamanrasset</option>
                      <option value="tebessa">Tebessa</option>
                      <option value="tlemcen">Tlemcen</option>
                      <option value="tiaret">Tiaret</option>
                      <option value="tizi ouzou">Tizi Ouzou</option>
                      <option value="algiers">Algiers</option>
                      <option value="djelfa">Djelfa</option>
                      <option value="jijel">Jijel</option>
                      <option value="setif">Setif</option>
                      <option value="saida">Saida</option>
                      <option value="skikda">Skikda</option>
                      <option value="sidi belabbes">Sidi Belabbes</option>
                      <option value="guelma">Guelma</option>
                      <option value="constantine">Constantine</option>
                      <option value="mostaganem">Mostaganem</option>
                      <option value="msila">M'sila</option>
                      <option value="mascara">Mascara</option>
                      <option value="ouargla">Ouargla</option>
                      <option value="oran">Oran</option>
                      <option value="el bayadh">El Bayadh</option>
                      <option value="bordj bou arreridj">Bordj Bou Arreridj</option>
                      <option value="boumerdes">Boumerdes</option>
                      <option value="el taref">El Taref</option>
                      <option value="tindouf">Tindouf</option>
                      <option value="tissemsilt">Tissemsilt</option>
                      <option value="el oued">El Oued</option>
                      <option value="khenchela">Khenchela</option>
                      <option value="souk ahras">Souk Ahras</option>
                      <option value="tipaza">Tipaza</option>
                      <option value="mila">Mila</option>
                      <option value="ain defla">Ain Defla</option>
                      <option value="naama">Naama</option>
                      <option value="ain temouchent">Ain Temouchent</option>
                      <option value="ghardaia">Ghardaia</option>
                      <option value="relizane">Relizane</option>
                      <option value="el mghair">El M'ghair</option>
                      <option value="el menia">El Menia</option>
                      <option value="ouled djellal">Ouled Djellal</option>
                      <option value="beni abbes">Beni Abbes</option>
                      <option value="timimoun">Timimoun</option>
                      <option value="touggourt">Touggourt</option>
                      <option value="djanet">Djanet</option>
                      <option value="in salah">In Salah</option>
                      <option value="in guezzam">In Guezzam</option>
                    </select>
                  </div>

                  <div>
                    <label class="label" for="commune">Commune</label>
                    <select id="commune" name="commune" required class="input">
                      <option value="">Sélectionnez d'abord la wilaya</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Hidden fields for shipping -->
              <input type="hidden" id="shippingFee" name="shippingFee" value="0">
              <input type="hidden" id="deliveryDelay" name="deliveryDelay" value="">
              <input type="hidden" id="totalPriceFinal" name="totalPriceFinal" value="<%= totalPrice %>">
            </form>
          </div>
        </div>

        <!-- Right Column - Order Summary -->
        <div class="md:col-span-1">
          <div class="zara-card p-8 sticky top-8">
            <h3 class="text-sm font-medium uppercase tracking-wide mb-6 border-b pb-2">Résumé de la commande</h3>
            
            <div class="space-y-4 mb-6">
              <div class="flex justify-between items-center">
                <div class="text-xs text-gray-600 uppercase tracking-wide">Total produits</div>
                <div class="text-sm font-medium" id="baseTotal"><%= totalPrice %> DA</div>
              </div>
              <div class="flex justify-between items-center">
                <div class="text-xs text-gray-600 uppercase tracking-wide">Frais de livraison</div>
                <div class="text-sm text-gray-700" id="shippingDisplay">—</div>
              </div>
              <div class="flex justify-between items-center">
                <div class="text-xs text-gray-600 uppercase tracking-wide">Délai estimé</div>
                <div class="text-xs text-gray-700" id="delayDisplay">—</div>
              </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
              <div class="flex justify-between items-center">
                <div class="text-sm font-medium uppercase tracking-wide">Total à payer</div>
                <div class="text-lg font-medium" id="totalDisplay"><%= totalPrice %> DA</div>
              </div>
            </div>

            <div class="space-y-3">
              <button id="placeOrderBtn" type="submit" form="checkoutForm" class="zara-btn w-full text-center">
                <i class="fas fa-lock mr-2"></i>Passer la commande — <span id="btn-total"><%= totalPrice %> DA</span>
              </button>
              
              <a href="tel:0791679611" class="zara-btn-secondary text-sm inline-block w-full text-center">
                <i class="fas fa-phone mr-2"></i>Appeler le support
              </a>
            </div>

            <!-- Security & Payment Info -->
            <div class="mt-6 pt-6 border-t border-gray-100">
              <div class="flex items-center justify-center gap-4 mb-4">
                <div class="text-xs text-gray-500">
                  <i class="fas fa-lock mr-1"></i> Paiement sécurisé
                </div>
                <div class="text-xs text-gray-500">
                  <i class="fas fa-truck mr-1"></i> Livraison garantie
                </div>
              </div>
              <p class="text-xs text-gray-500 text-center">
                Paiement à la livraison (CCP) disponible dans toutes les wilayas
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Support Info -->
      <div class="mt-12 text-center">
        <p class="text-sm text-gray-600">Besoin d'aide ? Contactez-nous au <a href="tel:0791679611" class="text-black underline">079 167 9611</a></p>
      </div>
    </div>
  </main>

  <!-- Footer include preserved -->
  <%- include ("../partials/footer") %>

  <!-- SCRIPT: shipping & communes logic -->
  <script>
    (function(){
      const FREE_SHIPPING_THRESHOLD = 5000;
      const basePrice = Number(<%= totalPrice || 0 %>);
      const citySelect = document.getElementById('city');
      const communeSelect = document.getElementById('commune');
      const shippingDisplay = document.getElementById('shippingDisplay');
      const delayDisplay = document.getElementById('delayDisplay');
      const totalDisplay = document.getElementById('totalDisplay');
      const baseTotalEl = document.getElementById('baseTotal');
      const btnTotalEl = document.getElementById('btn-total');
      const shippingFeeInput = document.getElementById('shippingFee');
      const deliveryDelayInput = document.getElementById('deliveryDelay');
      const totalPriceFinalInput = document.getElementById('totalPriceFinal');

      // Keep base total displayed
      baseTotalEl.innerText = formatPrice(basePrice);
      totalDisplay.innerText = formatPrice(basePrice);
      btnTotalEl.innerText = formatPrice(basePrice);

     // Shipping data (fees, delay, and communes per wilaya — full version)
const shippingData = {
  "adrar": { fee: 800, delay: "4–6 jours", communes: [
    "Adrar","Reggane","Aoulef","Timimoun","Zaouiet Kounta","Fenoughil","Bouda","Tamentit","Sali","Tsabit","In Zghmir","Ouled Ahmed Timmi"
  ]},
  "chlef": { fee: 500, delay: "2–4 jours", communes: [
    "Chlef","Ténès","Oued Fodda","El Karimia","Sidi Akkacha","Ouled Fares","Sendjas","El Marsa","Oued Goussine","Taougrit","Zeboudja","Benairia","Herenfa","Beni Haoua","Beni Rached","Sobha","Labiod Medjadja"
  ]},
  "laghouat": { fee: 650, delay: "3–5 jours", communes: [
    "Laghouat","Aflou","Brida","Sidi Makhlouf","Ksar El Hirane","Gueltat Sidi Saad","El Assafia","Oued Morra","Tadjmout","El Ghicha","Hassi R'Mel","Sebgag","Ain Madhi"
  ]},
  "oum el bouaghi": { fee: 550, delay: "2–4 jours", communes: [
    "Oum El Bouaghi","Ain Beida","Ain M'Lila","Sigus","Ain Babouche","Behir Chergui","Fkirina","Ksar Sbahi","El Fedjoudj","Souk Naamane","El Belala","Ain Kercha"
  ]},
  "batna": { fee: 550, delay: "2–4 jours", communes: [
    "Batna","Timgad","Barika","Merouana","N Gaous","Arris","Ain Touta","Seriana","Chemora","Djerma","Fesdis","Ouled Fadel","Oued Chaaba","El Madher","Tazoult"
  ]},
  "bejaia": { fee: 500, delay: "2–3 jours", communes: [
    "Bejaia","Akbou","Amizour","El Kseur","Tichy","Tazmalt","Seddouk","Adekar","Kendira","Aokas","Chemini","Souk El Tenine","Tifra","Taskriout","Barbacha"
  ]},
  "biskra": { fee: 600, delay: "3–5 jours", communes: [
    "Biskra","El Kantara","Sidi Okba","Tolga","Ouled Djellal","Mekhadma","Zeribet El Oued","Ourlal","Chetma","El Haouch","Doucen","Foughala","Branis"
  ]},
  "bechar": { fee: 750, delay: "4–6 jours", communes: [
    "Bechar","Kenadsa","Beni Ounif","Taghit","Abadla","Ouled Khoudir","Erg Ferradj","Beni Abbes","Timoudi","Tamtert","Igli"
  ]},
  "blida": { fee: 300, delay: "1–2 jours", communes: [
    "Blida","Boufarik","Bouinan","Ouled Yaich","Beni Mered","Chebli","Mouzaïa","Meftah","Oued El Alleug","Larbaa","Chréa","Soumaa","El Affroun"
  ]},
  "bouira": { fee: 450, delay: "2–3 jours", communes: [
    "Bouira","Ain Turk","El Asnam","Sour El Ghozlane","Lakhdaria","Bechloul","Haizer","Bir Ghbalou","Taghzout","El Hachimia","Dirah","El Khabouzia","Maamora"
  ]},
  "tamanrasset": { fee: 900, delay: "5–8 jours", communes: [
    "Tamanrasset","In Guezzam","In Salah","Tin Zaouatine","Abalessa"
  ]},
  "tebessa": { fee: 600, delay: "3–5 jours", communes: [
    "Tebessa","Bir El Ater","Cheria","El Aouinet","El Kouif","Negrine","Bir Mokadem","El Malabiod","Boukhadra","Morsott"
  ]},
  "tlemcen": { fee: 500, delay: "2–4 jours", communes: [
    "Tlemcen","Maghnia","Remchi","Hennaya","Sabra","Chetouane","Ghazaouet","Nedroma","Ain Fezza","Ain Tallout","Bensekrane"
  ]},
  "tiaret": { fee: 500, delay: "2–4 jours", communes: [
    "Tiaret","Sougueur","Meghila","Mahdia","Ain Bouchekif","Rahouia","Medroussa","Frenda","Sidi Ali Mellal","Oued Lilli"
  ]},
  "tizi ouzou": { fee: 400, delay: "2–3 jours", communes: [
    "Tizi Ouzou","Azazga","Aït Yahia","Larbaa Nath Irathen","Ouaguenoun","Draa El Mizan","Makouda","Freha","Illoula Oumalou","Iferhounene","Tigzirt","Azeffoun"
  ]},
  "algiers": { fee: 300, delay: "1–2 jours", communes: [
    "Alger Centre","Bab El Oued","El Madania","Hussein Dey","Bir Mourad Rais","Birkhadem","Hydra","El Harrach","Kouba","Bordj El Kiffan","Ain Benian","Cheraga","Zeralda","Draria","El Achour"
  ]},
  "djelfa": { fee: 600, delay: "3–5 jours", communes: [
    "Djelfa","Hassi Bahbah","Ain Oussera","Dar Chioukh","El Idrissia","Charef","Messaad","Zaafrane","El Khemis","Guernini"
  ]},
  "jijel": { fee: 500, delay: "2–4 jours", communes: [
    "Jijel","Taher","El Aouana","Texenna","Chekfa","Ziama Mansouriah","El Milia","Settara"
  ]},
  "setif": { fee: 550, delay: "2–4 jours", communes: [
    "Setif","El Eulma","Ain Arnat","Beni Ourtilane","Babor","Guenzet","Bougaa","Ain Oulmene","Guidjel","Beni Aziz"
  ]},
  "saida": { fee: 500, delay: "2–4 jours", communes: [
    "Saida","Moulay Larbi","Tircine","Ain El Hadjar","Ouled Khaled","Doui Thabet","Hounet"
  ]},
  "skikda": { fee: 550, delay: "2–4 jours", communes: [
    "Skikda","Collo","El Hadaik","El Harrouch","Azzaba","Ben Azzouz","Filfila","Ramdane Djamel","Oum Toub"
  ]},
  "sidi belabbes": { fee: 500, delay: "2–4 jours", communes: [
    "Sidi Bel Abbes","Sfisef","Mostefa Ben Brahim","Ain El Berd","Tessala","Ben Badis","Telagh","Merine","Tenira","Makedra"
  ]},
  "guelma": { fee: 550, delay: "2–4 jours", communes: [
    "Guelma","Bouchegouf","Ain Larbi","Nechmaya","Oued Zenati","Bouati Mahmoud","Belkheir","Ain Makhlouf","Hammam Debagh"
  ]},
  "constantine": { fee: 500, delay: "2–3 jours", communes: [
    "Constantine","El Khroub","Zighout Youcef","Ain Smara","Didouche Mourad","Ibn Ziad","Hamma Bouziane"
  ]},
  "mostaganem": { fee: 450, delay: "2–3 jours", communes: [
    "Mostaganem","Ain Tedles","Bouguirat","Hassi Mameche","Mesra","Sirat","Achaacha","Sidi Ali","Fornaka","Kheir Eddine"
  ]},
  "msila": { fee: 500, delay: "2–4 jours", communes: [
    "M'sila","Ouled Derradj","Sidi Aissa","Ain El Hadjel","Bou Saada","Ben Srour","Maadid","Hammam Dhalaa","Magra"
  ]},
  "mascara": { fee: 500, delay: "2–4 jours", communes: [
    "Mascara","Sig","Ghriss","Bouhanifia","Oued Taria","Froha","Tizi","El Bordj","Zahana","Ain Fekan"
  ]},
  "ouargla": { fee: 700, delay: "4–6 jours", communes: [
    "Ouargla","Hassi Messaoud","Rouissat","N'Goussa","Sidi Khouiled","Ain Beida","Touggourt","El Hadjira"
  ]},
  "oran": { fee: 400, delay: "2–3 jours", communes: [
    "Oran","Es Senia","Arzew","Gdyel","Bir El Djir","Hassi Bounif","Mers El Kebir","Ain El Turk","Bethioua","Sidi Chami"
  ]},
  "el bayadh": { fee: 750, delay: "4–6 jours", communes: [
    "El Bayadh","Bougtob","Rogassa","Brezina","Labiodh Sidi Cheikh","Chellala","Arbaouat","Ghassoul"
  ]},
  "bordj bou arreridj": { fee: 500, delay: "2–4 jours", communes: [
    "Bordj Bou Arreridj","Rabta","Zemmoura","El Hamadia","El Achir","Hasnaoua","Ain Taghrout","Djaafra","Mansoura","Medjana"
  ]},
  "boumerdes": { fee: 350, delay: "1–2 jours", communes: [
    "Boumerdes","Dellys","Thenia","Boudouaou","Khemis El Khechna","Naciria","Si Mustapha","Bordj Menaiel","Ouled Moussa","Tidjelabine"
  ]},
  "el taref": { fee: 600, delay: "3–5 jours", communes: [
    "El Tarf","Bouhadjar","Ben M'Hidi","Bouteldja","Souarekh","El Kala","Berrihane","Raml Souk","Zitouna"
  ]},
  "tindouf": { fee: 1000, delay: "6–9 jours", communes: ["Tindouf","Oum El Assel"] },
  "tissemsilt": { fee: 500, delay: "3–5 jours", communes: [
    "Tissemsilt","Bordj Bounaama","Lardjem","Beni Chaib","Theniet El Had","Khémisti","Melaab","Bordj Emir Abdelkader","Sidi Boutouchent"
  ]},
  "el oued": { fee: 700, delay: "4–6 jours", communes: [
    "El Oued","Djamaa","Bayoud","Mih Ouensa","Robbah","Reguiba","Kouinine","Guemar","Taghzout"
  ]},
  "khenchela": { fee: 600, delay: "3–5 jours", communes: [
    "Khenchela","Chelia","Chechar","El Hamma","Baghai","Bouhmama","Ain Touila","Kais","Tamza"
  ]},
  "souk ahras": { fee: 600, delay: "3–5 jours", communes: [
    "Souk Ahras","Taoura","Bir Bouhouche","Heddada","Mechroha","Sedrata","Oum El Adhaim","Ouillen","Zaarouria","Khedara"
  ]},
  "tipaza": { fee: 350, delay: "1–2 jours", communes: [
    "Tipaza","Merad","Koléa","Bou Ismail","Cherchell","Hadjout","Sidi Amar","Fouka","Ain Tagourait","Menaceur"
  ]},
  "mila": { fee: 500, delay: "2–4 jours", communes: [
    "Mila","Tikrirt","Sidi Merouane","Chelghoum Laid","Ferdjioua","Tassala Lematai","Rouached","Grah Bou Noura","Hamala"
  ]},
  "ain defla": { fee: 400, delay: "2–3 jours", communes: [
    "Ain Defla","El Abadia","Miliana","Boumedfaa","El Amra","Djelida","Tacheta Zougagha","Rouina","Khemis Miliana","Bordj Emir Khaled"
  ]},
  "naama": { fee: 750, delay: "4–6 jours", communes: [
    "Naama","Mecheria","Sfissifa","Ain Sefra","Kasdir","Tiout","El Biodh","Assela"
  ]},
  "ain temouchent": { fee: 500, delay: "2–4 jours", communes: [
    "Ain Temouchent","Sidi Safi","El Amria","Hammam Bouhadjar","Oulhaca El Gheraba","El Malah","Aghlal","Chaabat El Ham"
  ]},
  "ghardaia": { fee: 700, delay: "4–6 jours", communes: [
    "Ghardaia","El Atteuf","Metlili","Berriane","El Guerrara","Zelfana","Dhayet Bendhahoua"
  ]},
  "relizane": { fee: 500, delay: "2–4 jours", communes: [
    "Relizane","Oued Rhiou","Mansourah","Yellel","Mazouna","Ammi Moussa","El H'Madna","Ouled Sidi Mihoub","Mediouna","Sidi Saada"
  ]},
  "el mghair": { fee: 700, delay: "4–6 jours", communes: ["El M'Ghair","Djamaa","Oum Touyour"] },
  "el menia": { fee: 750, delay: "4–6 jours", communes: ["El Menia","Hassi Messaoud","Hassi Gara"] },
  "ouled djellal": { fee: 650, delay: "4–6 jours", communes: ["Ouled Djellal","Sidi Khaled","Doucen"] },
  "beni abbes": { fee: 800, delay: "5–7 jours", communes: ["Beni Abbes","Tamtert","El Ouata","Ouled Khoudir"] },
  "timimoun": { fee: 800, delay: "5–7 jours", communes: ["Timimoun","Tinerkouk","Ouled Said","Aougrout","Charouine"] },
  "touggourt": { fee: 700, delay: "4–6 jours", communes: ["Touggourt","Megarine","Nezla","Sidi Slimane","Blidet Amor"] },
  "djanet": { fee: 950, delay: "6–9 jours", communes: ["Djanet","Bordj El Haouass","Illizi"] },
  "in salah": { fee: 850, delay: "6–9 jours", communes: ["In Salah","Foggaret Ezzoua","Ain Salah Sud"] },
  "in guezzam": { fee: 1000, delay: "7–10 jours", communes: ["In Guezzam","Tin Zouatine","Taessa"] }
};


      // Helper: format price with thousand separator
      function formatPrice(n) {
        try {
          return new Intl.NumberFormat('fr-DZ').format(Number(n)) + ' DA';
        } catch (e) {
          return n + ' DA';
        }
      }

      // Populate commune dropdown given selected wilaya key
      function populateCommunes(wilayaKey) {
        communeSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Sélectionnez une commune';
        communeSelect.appendChild(defaultOpt);

        const entry = shippingData[wilayaKey];
        if (!entry || !Array.isArray(entry.communes)) {
          // fallback: simple text
          const fallback = document.createElement('option');
          fallback.value = '';
          fallback.textContent = 'Aucune commune disponible';
          communeSelect.appendChild(fallback);
          communeSelect.value = '';
          return;
        }

        entry.communes.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          communeSelect.appendChild(opt);
        });
      }

      // Update shipping info UI + hidden fields
      function updateShippingForWilaya(wilayaKey) {
        if (!wilayaKey) {
          shippingDisplay.innerText = '—';
          delayDisplay.innerText = '—';
          shippingFeeInput.value = 0;
          deliveryDelayInput.value = '';
          updateTotalDisplay(basePrice);
          return;
        }

        const normalized = wilayaKey.toString().toLowerCase().trim();
        const data = shippingData[normalized] || { fee: 700, delay: '3–5 jours', communes: [] };

        let shippingFee = data.fee;
        if (basePrice >= FREE_SHIPPING_THRESHOLD) {
          shippingFee = 0;
        }

        const delivery = data.delay || '3–5 jours';
        const total = basePrice + (shippingFee || 0);

        shippingDisplay.innerText = (shippingFee === 0) ? `Gratuit` : formatPrice(shippingFee);
        delayDisplay.innerText = delivery;
        shippingFeeInput.value = shippingFee;
        deliveryDelayInput.value = delivery;
        totalPriceFinalInput.value = total;

        updateTotalDisplay(total);
      }

      function updateTotalDisplay(total) {
        totalDisplay.innerText = formatPrice(total);
        btnTotalEl.innerText = formatPrice(total);
        // Also update base total (keeps clarity)
        baseTotalEl.innerText = formatPrice(basePrice);
      }

      // Event: when user selects wilaya
      citySelect.addEventListener('change', function(e){
        const val = (this.value || '').toLowerCase();
        populateCommunes(val);
        updateShippingForWilaya(val);
      });

      // Event: when commune chosen (no extra effect for now but we keep it)
      communeSelect.addEventListener('change', function(){
        // Optionally, we could adjust shipping slightly by commune — currently not implemented.
      });

      // Initialize if server preselected a wilaya (attempt to match server-side city variable)
      (function initFromServer() {
        try {
          <% if (typeof city !== 'undefined' && city) { %>
            const serverCity = '<%= (city || '').toString().toLowerCase() %>';
            // set city select if found
            for (let i=0;i<citySelect.options.length;i++){
              if (citySelect.options[i].value.toLowerCase() === serverCity) {
                citySelect.selectedIndex = i;
                const ev = new Event('change'); citySelect.dispatchEvent(ev);
                // Optionally set commune if server provided
                <% if (typeof commune !== 'undefined' && commune) { %>
                  setTimeout(()=> {
                    const targetComm = '<%= (commune || "").toString() %>';
                    for (const opt of communeSelect.options) {
                      if (opt.value === targetComm) { opt.selected = true; break; }
                    }
                  }, 200);
                <% } %>
                break;
              }
            }
          <% } %>
        } catch(e) {}
      })();

      // Form submit: ensure hidden totals are set (final guard)
      const form = document.getElementById('checkoutForm');
      form.addEventListener('submit', function(e){
        // Validate required fields client-side (just a safety)
        if (!citySelect.value || !communeSelect.value) {
          e.preventDefault();
          alert('Veuillez sélectionner votre wilaya et votre commune.');
          return false;
        }
        // Ensure hidden inputs reflect current values
        shippingFeeInput.value = shippingFeeInput.value || 0;
        deliveryDelayInput.value = deliveryDelayInput.value || '';
        totalPriceFinalInput.value = totalPriceFinalInput.value || basePrice;
        // allow submit to continue
      });

    })();
  </script>

</body>
</html>
