<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paintello | Panier</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f8f8f8;
    }
    
    .zara-card {
      background: white;
      border-radius: 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e5e5e5;
    }
    
    .zara-btn {
      background: #000;
      color: white;
      border: 1px solid #000;
      padding: 12px 24px;
      font-size: 13px;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }
    
    .zara-btn:hover {
      background: #333;
    }
    
    .zara-btn-secondary {
      background: transparent;
      color: #000;
      border: 1px solid #000;
    }
    
    .zara-btn-secondary:hover {
      background: #000;
      color: white;
    }
    
    .quantity-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #e5e5e5;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .quantity-btn:hover {
      background: #f8f8f8;
    }
    
    .quantity-input {
      width: 40px;
      height: 32px;
      border: 1px solid #e5e5e5;
      border-left: none;
      border-right: none;
      text-align: center;
      font-size: 13px;
    }
  </style>

  <!-- Pixel, GTM, Clarity -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');

    var pixelConfig = {};
    <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
    <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
    <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
    <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
    <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>

    fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
    fbq('track', 'PageView', {}, {
    eventID: '<%= metaEventIdPageView %>'
  });
  </script>
  <% } %>
  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K8PWQM45');</script>

  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>
</head>

<body class="min-h-screen bg-white">
  <!-- Minimal Header -->
  <header class="border-b border-gray-200 bg-white">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- Logo -->
        <a href="/" class="flex items-center gap-4">
          <img src="/favicon/android-chrome-192x192.png" alt="Paintello" class="h-8 w-8">
          <img src="/img/logo.png" alt="Paintello Home" class="h-10 w-auto">
        </a>

        <!-- Navigation -->
        <nav class="hidden md:flex items-center gap-8">
          <a href="/" class="text-sm text-gray-600 hover:text-gray-900 uppercase tracking-wide">Accueil</a>
          <a href="/shop" class="text-sm text-gray-600 hover:text-gray-900 uppercase tracking-wide">Boutique</a>
          <a href="/track-login" class="text-sm text-gray-600 hover:text-gray-900 uppercase tracking-wide">Suivi</a>
        </nav>

        <!-- Icons -->
        <div class="flex items-center gap-4">
          <a href="/shop" class="relative text-gray-600 hover:text-gray-900">
            <i class="fa-solid fa-bag-shopping text-lg"></i>
            <% if (session.cart && session.cart.totalQty > 0) { %>
              <span class="absolute -top-2 -right-2 bg-black text-white text-xs px-1.5 py-0.5 rounded-full">
                <%= session.cart.totalQty %>
              </span>
            <% } %>
          </a>
          
          <a href="/user/profile" class="text-gray-600 hover:text-gray-900">
            <i class="fa-regular fa-user text-lg"></i>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="py-12">
    <div class="max-w-6xl mx-auto px-6">
      
      <!-- Page Header -->
      <div class="text-center mb-12">
        <h1 class="text-3xl font-light tracking-wide uppercase mb-4">Votre Panier</h1>
        <p class="text-sm text-gray-600">Révisez vos articles avant de finaliser votre commande</p>
      </div>

      <% if (products && products.length > 0) { %>
      <div class="grid lg:grid-cols-3 gap-12">
        <!-- Cart Items -->
        <div class="lg:col-span-2">
          <div class="zara-card p-8">
            <div class="flex items-center justify-between mb-8 pb-6 border-b border-gray-200">
              <h2 class="text-sm font-medium uppercase tracking-wide">
                Votre Sélection (<%= session.cart.totalQty %> articles)
              </h2>
              <span class="text-xs text-gray-500 uppercase tracking-wide">
                Total: <span id="total-price" class="font-medium"><%= totalPrice %> DA</span>
              </span>
            </div>

            <div class="space-y-8">
              <% products.forEach(function(product){ %>
              <div class="flex flex-col sm:flex-row gap-6 pb-8 border-b border-gray-100 last:border-b-0">
                <!-- Product Image -->
                <div class="flex-shrink-0">
                  <img src="<%= product.item.image %>" alt="<%= product.item.title %>" 
                       class="w-24 h-24 object-cover">
                </div>

                <!-- Product Details -->
                <div class="flex-grow">
                  <h3 class="text-sm font-medium mb-2"><%= product.item.title %></h3>
                  <p class="text-xs text-gray-600 mb-4 leading-relaxed">
                    <%= product.item.description?.slice(0, 80) || 'Produit de qualité supérieure' %>...
                  </p>
                  
                  <!-- Quantity Controls -->
                  <div class="flex items-center gap-4">
                    <div class="flex items-center">
                      <button class="quantity-btn btn-decrease" data-id="<%= product.item._id %>">
                        <i class="fas fa-minus text-xs"></i>
                      </button>
                      <input type="text" value="<%= product.qty %>" readonly 
                             class="quantity-input item-qty" data-id="<%= product.item._id %>">
                      <button class="quantity-btn btn-increase" data-id="<%= product.item._id %>">
                        <i class="fas fa-plus text-xs"></i>
                      </button>
                    </div>
                    
                    <span class="text-sm font-medium product-subtotal" data-id="<%= product.item._id %>">
                      <%= product.price %> DA
                    </span>
                  </div>
                </div>

                <!-- Remove Button -->
                <div class="flex sm:flex-col sm:items-end justify-between">
                  <button class="text-gray-400 hover:text-gray-600 transition-colors remove-item" 
                          data-id="<%= product.item._id %>">
                    <i class="fas fa-times text-sm"></i>
                  </button>
                </div>
              </div>
              <% }); %>
            </div>
          </div>

          <!-- Shipping Info -->
          <div class="zara-card p-6 mt-6 text-center">
            <div class="flex items-center justify-center gap-3 mb-3">
              <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-truck text-gray-600 text-xs"></i>
              </div>
              <h3 class="text-sm font-medium uppercase tracking-wide">Livraison & Retours</h3>
            </div>
            <p class="text-xs text-gray-600 leading-relaxed">
              Livraison sous 2-4 jours ouvrables • Retours acceptés sous 4 jours • Paiement à la livraison
            </p>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
          <div class="zara-card p-8 sticky top-8">
            <h3 class="text-sm font-medium uppercase tracking-wide mb-6 border-b border-gray-200 pb-3">
              Récapitulatif
            </h3>
            
            <div class="space-y-4 mb-6">
              <div class="flex justify-between items-center">
                <span class="text-xs text-gray-600 uppercase tracking-wide">Sous-total</span>
                <span class="text-sm font-medium"><%= totalPrice %> DA</span>
              </div>
              <!-- Delivery Partner Info -->
      <div class="flex justify-between items-center pt-2 border-t border-gray-100">
        <span class="text-xs text-gray-500">Livraison par</span>
        <div class="flex items-center gap-2">
          <img src="/favicon/mylerz.png" alt="Mylerz" class="h-5 w-auto object-contain">
          <span class="text-xs text-gray-600">Mylerz</span>
        </div>
      </div>
            
            <div class="border-t border-gray-200 pt-4 mb-6">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium uppercase tracking-wide">Total</span>
                <span class="text-lg font-medium" id="btn-total"><%= totalPrice %> DA</span>
              </div>
            </div>

            <div class="space-y-3">
              <form method="GET" action="/checkout">
                <button type="submit" class="zara-btn w-full text-center">
                  <i class="fas fa-lock mr-2"></i>Procéder au Paiement
                </button>
              </form>
              
              <a href="tel:0791679611" class="zara-btn-secondary text-sm inline-block w-full text-center">
                <i class="fas fa-phone mr-2"></i>Appeler le Support
              </a>
            </div>

            <!-- Security & Payment Info -->
            <div class="mt-6 pt-6 border-t border-gray-100">
              <div class="flex items-center justify-center gap-4 mb-3">
                <div class="text-xs text-gray-500">
                  <i class="fas fa-lock mr-1"></i> Paiement sécurisé
                </div>
                <div class="text-xs text-gray-500">
                  <i class="fas fa-truck mr-1"></i> Livraison garantie
                </div>
              </div>
              <p class="text-xs text-gray-500 text-center">
                Paiement à la livraison  disponible
              </p>
            </div>
          </div>
        </div>
      </div>

      <% } else { %>
        <!-- Empty Cart -->
        <div class="zara-card p-12 text-center max-w-md mx-auto">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-shopping-bag text-gray-400"></i>
          </div>
          <h2 class="text-lg font-light tracking-wide uppercase mb-4">Panier Vide</h2>
          <p class="text-sm text-gray-600 mb-6">Votre panier est actuellement vide</p>
          <a href="/paintello" class="zara-btn inline-block text-sm">
            <i class="fas fa-bag-shopping mr-2"></i>Découvrir la Boutique
          </a>
        </div>
      <% } %>
    </div>
  </main>

  <!-- Minimal Footer -->
  <footer class="border-t border-gray-200 py-8">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <p class="text-sm text-gray-600">© <%= new Date().getFullYear() %> Paintello</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const increaseBtns = document.querySelectorAll(".btn-increase");
      const decreaseBtns = document.querySelectorAll(".btn-decrease");
      const removeBtns = document.querySelectorAll(".remove-item");

      // Format price helper
      const formatPrice = (num) => new Intl.NumberFormat("fr-DZ").format(num) + " DA";

      // Global total updater
      function updateTotalsDisplay(totalPrice) {
        const totalEl = document.getElementById("total-price");
        const btnTotal = document.getElementById("btn-total");
        if (totalEl) totalEl.innerText = formatPrice(totalPrice);
        if (btnTotal) btnTotal.innerText = formatPrice(totalPrice);
      }

      // Update cart item quantity (frontend + backend sync)
      function updateQty(productId, action) {
        fetch(`/cart/${action}/${productId}`, { method: "POST" })
          .then((res) => res.json())
          .then((data) => {
            // Update item quantity
            const qtyEl = document.querySelector(`.item-qty[data-id="${productId}"]`);
            if (qtyEl) qtyEl.value = data.qty;

            // Update item subtotal
            const subtotalEl = document.querySelector(`.product-subtotal[data-id="${productId}"]`);
            if (subtotalEl) subtotalEl.innerText = formatPrice(data.itemTotal);

            // Update all totals (cart + button)
            updateTotalsDisplay(data.totalPrice || 0);
          })
          .catch((err) => console.error("Update quantity error:", err));
      }

      // Remove item from cart
      function removeItem(productId) {
        fetch(`/cart/remove/${productId}`, { method: "POST" })
          .then((res) => res.json())
          .then((data) => {
            // Reload page to reflect changes
            window.location.reload();
          })
          .catch((err) => console.error("Remove item error:", err));
      }

      // Attach listeners
      increaseBtns.forEach((btn) =>
        btn.addEventListener("click", () => updateQty(btn.dataset.id, "increase"))
      );
      decreaseBtns.forEach((btn) =>
        btn.addEventListener("click", () => updateQty(btn.dataset.id, "decrease"))
      );
      removeBtns.forEach((btn) =>
        btn.addEventListener("click", () => removeItem(btn.dataset.id))
      );
    });
  </script>

  <!-- Tawk.to -->
  <script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
      var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
      s1.async=true;
      s1.src='https://embed.tawk.to/682625d0a2b6be190d3ada7e/1irag7e08';
      s1.charset='UTF-8';
      s1.setAttribute('crossorigin','*');
      s0.parentNode.insertBefore(s1,s0);
    })();
  </script>
</body>
</html>

