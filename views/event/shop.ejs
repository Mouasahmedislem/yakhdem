<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paintello | Panier</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --accent: #f4791f;
    }
    body {
      background-color: #fafafa;
    }
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.8);
    }
  </style>

  <!-- Pixel, GTM, Clarity -->
  <% if (process.env.FB_PIXEL_ID) { %>
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window,document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');

    var pixelConfig = {};
    <% if (user && user.email) { %> pixelConfig.em = '<%= user.email %>'; <% } %>
    <% if (user && user.firstName) { %> pixelConfig.fn = '<%= user.firstName %>'; <% } %>
    <% if (user && user.lastName) { %> pixelConfig.ln = '<%= user.lastName %>'; <% } %>
    <% if (user && user.numero) { %> pixelConfig.ph = '<%= user.numero %>'; <% } %>
    <% if (user && user._id) { %> pixelConfig.external_id = '<%= user._id %>'; <% } %>

    fbq('init', '<%= process.env.FB_PIXEL_ID %>', pixelConfig);
    fbq('track', 'PageView');
  </script>
  <% } %>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K8PWQM45');</script>

  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "t8r0mi7k1l");
  </script>
</head>

<body class="font-sans text-gray-800 antialiased">

  <!-- Modern Navbar -->
  <header class="border-b border-gray-100 bg-white/80 backdrop-blur-md sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <a href="/" class="flex items-center gap-4">
          <img src="/img/logo.png" alt="Paintello" class="h-16 w-auto" />
          <span class="text-lg font-medium text-gray-700 hidden sm:block">Paintello Home</span>
        </a>
        <nav class="flex items-center gap-6">
          <a href="/shop" class="text-sm text-gray-600 hover:text-gray-900">Shop</a>
          <a href="/track-login" class="text-sm text-gray-600 hover:text-gray-900">Returns</a>
          <a href="/user/signin" class="text-sm text-gray-600 hover:text-gray-900">Sign in</a>
          <a href="/shop" class="relative inline-flex items-center px-4 py-2 rounded-full bg-gray-50 hover:bg-gray-100">
            <i class="fas fa-shopping-cart"></i>
            <% if (session.cart && session.cart.totalQty > 0) { %>
              <span class="ml-2 text-xs font-semibold text-gray-700">(<%= session.cart.totalQty %>)</span>
            <% } %>
          </a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 lg:px-8 py-10">
    <% if (products && products.length > 0) { %>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
      <!-- LEFT: Cart items -->
      <section class="lg:col-span-8 space-y-6">
        <div class="glass rounded-2xl shadow-sm p-6">
          <h2 class="text-xl font-semibold mb-6">Votre panier (<%= session.cart.totalQty %> articles)</h2>
          
          <% products.forEach(function(product){ %>
          <div class="flex flex-col sm:flex-row items-center justify-between border-b border-gray-100 pb-4 mb-4">
            <div class="flex items-center gap-4 w-full sm:w-auto">
              <img src="<%= product.item.image %>" alt="<%= product.item.title %>" class="w-28 h-28 object-cover rounded-lg shadow-sm">
              <div>
                <h3 class="font-medium text-gray-900"><%= product.item.title %></h3>
                <p class="text-sm text-gray-500 mt-1"><%= product.item.description?.slice(0, 60) || '' %></p>
              </div>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-4 mt-4 sm:mt-0">
              <div class="flex items-center border rounded-full overflow-hidden">
                <button class="px-3 py-1 text-gray-700 hover:bg-gray-100 btn-decrease" data-id="<%= product.item._id %>">−</button>
                <span class="px-4 item-qty text-gray-800" data-id="<%= product.item._id %>"><%= product.qty %></span>
                <button class="px-3 py-1 text-gray-700 hover:bg-gray-100 btn-increase" data-id="<%= product.item._id %>">+</button>
              </div>
              <div class="text-lg font-semibold text-[color:var(--accent)] product-subtotal" data-id="<%= product.item._id %>">
                <%= product.price %> DA
              </div>
            </div>
          </div>
          <% }); %>
        </div>

        <div class="glass rounded-2xl shadow-sm p-6 text-sm text-gray-600">
          Livraison estimée : <strong>1 à 4 jours</strong>
        </div>
      </section>

      <!-- RIGHT: Summary -->
      <aside class="lg:col-span-4">
        <div class="glass rounded-2xl shadow-sm p-6 sticky top-24">
          <h3 class="text-lg font-semibold mb-4">Résumé</h3>
          <div class="flex justify-between text-sm border-b border-gray-100 pb-2 mb-3">
            <span>Total temporaire</span>
            <span id="total-price" class="font-medium"><%= totalPrice %> DA</span>
          </div>

          <form method="GET" action="/checkout" class="flex flex-col gap-3">
            <button type="submit" class="w-full py-3 rounded-full text-white font-semibold hover:opacity-90 transition-opacity" style="background:var(--accent);" onclick="trackCheckout(<%= totalPrice %>)">
              Commander — <%= totalPrice %> DA
            </button>
            <a href="tel:0791679611" class="w-full inline-flex justify-center items-center py-3 rounded-full border border-gray-200 hover:border-gray-300">
              <i class="fas fa-phone-alt text-[color:var(--accent)] mr-2"></i> Appeler
            </a>
          </form>
        </div>
      </aside>
    </div>
    <% } else { %>
      <div class="text-center py-20">
        <h2 class="text-2xl font-semibold mb-4">Votre panier est vide</h2>
        <a href="/" class="inline-block bg-[color:var(--accent)] text-white px-6 py-3 rounded-full hover:opacity-90 transition">Retourner à la boutique</a>
      </div>
    <% } %>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-100 bg-white mt-16">
    <div class="max-w-7xl mx-auto px-6 py-8 text-sm text-gray-600">
      © <%= new Date().getFullYear() %> Paintello — Tous droits réservés
    </div>
  </footer>

  <!-- Scripts -->
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const increaseBtns = document.querySelectorAll(".btn-increase");
  const decreaseBtns = document.querySelectorAll(".btn-decrease");

  // Format price helper
  function formatPrice(num) {
    return new Intl.NumberFormat("fr-DZ").format(num) + " DA";
  }

  // Update cart item quantity (frontend + backend sync)
  function updateQty(productId, action) {
    fetch(`/cart/${action}/${productId}`, { method: "POST" })
      .then((res) => res.json())
      .then((data) => {
        // Update item quantity
        const qtyEl = document.querySelector(`.item-qty[data-id="${productId}"]`);
        if (qtyEl) qtyEl.innerText = data.qty;

        // Update item subtotal
        const subtotalEl = document.querySelector(`.product-subtotal[data-id="${productId}"]`);
        if (subtotalEl) subtotalEl.innerText = formatPrice(data.itemTotal);

        // Update total price
        const totalEl = document.getElementById("total-price");
        if (totalEl) totalEl.innerText = formatPrice(data.totalPrice);

        // Update button “Commander — total”
        const btnTotal = document.getElementById("btn-total");
        if (btnTotal) btnTotal.innerText = formatPrice(data.totalPrice);
      })
      .catch((err) => console.error("Update quantity error:", err));
  }

  // Attach listeners
  increaseBtns.forEach((btn) =>
    btn.addEventListener("click", () => updateQty(btn.dataset.id, "increase"))
  );
  decreaseBtns.forEach((btn) =>
    btn.addEventListener("click", () => updateQty(btn.dataset.id, "decrease"))
  );
});

// Meta Pixel checkout event
function trackCheckout(totalPrice) {
  if (window.fbq) {
    fbq("track", "InitiateCheckout", {
      value: totalPrice,
      currency: "DZD",
    });
  }
}
</script>


  <!-- Tawk.to -->
  <script type="text/javascript">
  var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
  (function(){
  var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
  s1.async=true;
  s1.src='https://embed.tawk.to/682625d0a2b6be190d3ada7e/1irag7e08';
  s1.charset='UTF-8';
  s1.setAttribute('crossorigin','*');
  s0.parentNode.insertBefore(s1,s0);
  })();
  </script>

  <script src="https://kit.fontawesome.com/a2d9b6b9f4.js" crossorigin="anonymous" defer></script>
</body>
</html>

